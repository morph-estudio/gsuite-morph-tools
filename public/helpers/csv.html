<div id="icsv" style="display: none;" class="mt-3 mb-2">

<div class="accordion-body p-3 mt-2">

  <h3 class="menu-h3 mb-3"><i class="fa-solid fa-margin fa-fw fa-file-csv"></i>Importar CSV</h3>

  <div id="newinput">
    <div id="row" class="input-group flex-nowrap update rounded-pill mb-2">
      <span class="input-group-text"><i class="fa-solid fa-link"></i></span>
      <input type="text" class="form-control shadow-none" id="csvURL0" placeholder="https://drive.google.com/file/">
      <span class="input-group-text"><i class="fa-solid fa-table-cells-large"></i></span>
      <input type="text" class="form-control shadow-none" style="width:5% !important" id="csvCELL0" placeholder="A1">
      <button class="btn btn-dark disabled" id="" type="button"><i class="fa-solid fa-wifi fa-fw"></i></button>
    </div>
  </div>

  <div class="d-flex mt-3 mb-1">
    <button class="btn btn-success btn-lg-gmt w-50 shadow-none me-1" id="moreFields" value="Añadir documento">Añadir</button>
    <button class="btn btn-outline-secondary btn-lg-gmt w-50 shadow-none ms-1" id="saveCSVOptions">Guardar</button>
  </div>

  <button class="btn btn-primary btn-xl w-100 shadow-none mt-1" id="csvMainButton">Importar CSV</button>

  <!--<button class="btn btn-danger btn-xl w-100 shadow-none mt-1" id="csvMainButton" onClick="alert(counter)">Counter</button>
  <button class="btn btn-danger btn-xl w-100 shadow-none mt-1" id="csvMainButton" onClick="alert(dat)">Object</button>

  <button class="btn btn-outline-danger btn-lg-gmt w-35 shadow-none ms-1 pt-1 pb-1" id="deleteButton" onclick="swalConfirm('deleteProperties', 'Se ha eliminado la configuración', 'Se eliminará la configuración guardada.')">Borrar</button> -->

</div>

</div>

<script>

  var counter = 0;
  var csvURL; var csvCELL;
  var rowData = {};
  var newRowAdd;

  $("#moreFields").click(function () {
    ++counter;
    newRowAdd =
    `<div id="row${counter}" class="input-group flex-nowrap update rounded-pill mb-2">` +
    '<span class="input-group-text"><i class="fa-solid fa-link"></i></span>' +
    `<input type="text" class="form-control shadow-none" id="csvURL${counter}" placeholder="https://drive.google.com/file/">` +
    '<span class="input-group-text"><i class="fa-solid fa-table-cells-large"></i></span>' +
    `<input type="text" class="form-control shadow-none" id="csvCELL${counter}" placeholder="A1">` +
    `<button class="btn btn-danger" id="deleteRow${counter}" type="button" onClick="reply_click(this.id)">` +
    '<i class="fa-solid fa-trash fa-fw"></i></button> </div>';

    $('#newinput').append(newRowAdd);
  });

  function reply_click(clicked_id) {
    $("body").on("click", `#deleteRow${clicked_id.slice(9)}`, function () {
        $(this).parents(`#row${clicked_id.slice(9)}`).remove();
    })
    --counter;
  }

</script>


<script>

  function csvImportForm() {

    rowData[`counter`] = counter;

    for (let i = 0; i <= counter; i++) {
      csvURL = document.getElementById(`csvURL${i}`).value; //alert(csvURL);
      csvCELL = document.getElementById(`csvCELL${i}`).value; //alert(csvCELL);
      rowData[`csvURL${i}`] = csvURL;
      rowData[`csvCELL${i}`] = csvCELL;
    }

    rowData[`newRowAdd`] = newRowAdd;
    // alert(JSON.stringify(rowData));
    return rowData;
  }

  function afterButtonCSVimport() {
    execNoSuccess('getCSVFilesData', csvImportForm(), counter);
  }

  function afterButtonCSVoptions() {
    execFunction('getSavedSheetProperties', 'Se ha guardado la configuración.', csvImportForm());
  }

  async function getSavedCSVImport() {

    google.script.run.withSuccessHandler(function(dataExtracted) {
      dat = JSON.stringify(dataExtracted)
      if (typeof dataExtracted[`counter`] !== 'undefined') {
        counter = Math.floor(dataExtracted[`counter`]);
      } else {
        counter = 0;
      };

      newRowAdd = dataExtracted[`newRowAdd`];

      for (let i = 1; i <= counter; i++) {
        newRowAdd =
        `<div id="row${i}" class="input-group flex-nowrap update rounded-pill mb-2">` +
        '<span class="input-group-text"><i class="fa-solid fa-link"></i></span>' +
        `<input type="text" class="form-control shadow-none" id="csvURL${i}" placeholder="https://drive.google.com/file/">` +
        '<span class="input-group-text"><i class="fa-solid fa-table-cells-large"></i></span>' +
        `<input type="text" class="form-control shadow-none" id="csvCELL${i}" placeholder="A1">` +
        `<button class="btn btn-danger" id="deleteRow${i}" type="button" onClick="reply_click(this.id)">` +
        '<i class="fa-solid fa-trash fa-fw"></i></button> </div>';

        $('#newinput').append(newRowAdd);
      }

      for (let i = 0; i <= counter; i++) {
        if (typeof dataExtracted[`csvURL${i}`] !== 'undefined') document.getElementById(`csvURL${i}`).value = dataExtracted[`csvURL${i}`];
        if (typeof dataExtracted[`csvCELL${i}`] !== 'undefined') document.getElementById(`csvCELL${i}`).value = dataExtracted[`csvCELL${i}`];
      }
    }).getDocProperties();
  }

  document.getElementById("csvMainButton").addEventListener("click", afterButtonCSVimport);
  document.getElementById("saveCSVOptions").addEventListener("click", afterButtonCSVoptions);

</script>