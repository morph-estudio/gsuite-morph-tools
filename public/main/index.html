<html>
<head>
  <base target="_top">
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <?!= HtmlService.createHtmlOutputFromFile('public/helpers/header').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('public/main/stylesheet').getContent(); ?>

</head>

<body>

<?!= HtmlService.createHtmlOutputFromFile('public/helpers/navbar').getContent(); ?>

<div class="houdini" style="display:none">
  <div class="d-flex align-items-center justify-content-center text-center">
      <a id="GMTUPDATEBUTTON" class="btn btn-danger popup rounded-0 w-100 text-decoration-none" href="#" role="button">
          
              <img src="https://cdna.artstation.com/p/assets/images/images/044/684/370/original/tiina-hirvonen-pet1-export.gif" style="margin-top:5px;margin-right: 5px;width:46px;height:31px" class="vertical-align-middle"/>
              <span style="font-weight:bold;font-size:16px;line-height:0em;vertical-align:middle">Actualización 1.8.5</span>
          <br>
          <span style="font-size:10px">La aplicación se ha actualizado recientemente. Si te produce algún fallo, contacta con I+D.</span>
      </a>
  </div>
</div>
<script>
    document.getElementById("GMTUPDATEBUTTON").addEventListener("click", function() {
        window.open("https://github.com/morph-estudio/gsuite-morph-tools/blob/main/CHANGELOG.md", "_blank"); // Abre la página en una nueva pestaña del navegador
    });
</script>
<script>
  window.setInterval(function() {
    var current = new Date();
    var expiry = new Date("May 26, 2023 00:00:00")

    if (current.getTime() > expiry.getTime()) {
      $('.houdini').hide();

    } else if (current.getTime() < expiry.getTime()) {
      $('.houdini').show();
    }

  }, 0);
</script>

<div class="accordion" id="accordionExample">

  <div class="accordion-item">
    <h2 class="accordion-header" id="headingCuadros">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCuadros" aria-expanded="true" aria-controls="collapseCuadros">
        Cuadros
      </button>
    </h2>
    <div id="collapseCuadros" class="accordion-collapse collapse show" aria-labelledby="headingCuadros" data-bs-parent="#accordionExample">
      <div class="accordion-body mt-2">

        <?!= HtmlService.createHtmlOutputFromFile('public/helpers/helpCuadros').getContent(); ?>
        <?!= HtmlService.createHtmlOutputFromFile('public/helpers/cuadros').getContent(); ?>

      </div>
    </div>
  </div>

  <div class="accordion-item">
    <h2 class="accordion-header" id="headingSheets">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSheets" aria-expanded="false" aria-controls="collapseSheets">
        Google Sheets
      </button>
    </h2>
    <div id="collapseSheets" class="accordion-collapse collapse" aria-labelledby="headingSheets" data-bs-parent="#accordionExample">
      <div class="accordion-body pb-0 mt-2">

        <!-- <div class="mt-1 pb-0">
          <p>En esta app tienes las funciones implementadas por el equipo I+D para Google Suite.</p>
        </div> -->

        <button id="superFreezerButton" class="btn btn-primary gmt blue btn-lg-gmt w-100 mt-1 mb-3 shadow-none centerScroll"  onclick="swalConfirm('morphFreezer', 'El archivo se ha congelado correctamente.', 'Una vez ejecutado no se puede detener. Confirma para continuar.', this.id)">Supercongelador</button>

      </div>

      <div id="button-container" class="accordion-body px-0 pb-0">

        <button class="btn btn-primary index shadow-none w-100" onclick="execNoSuccess('deleteEmptyRows')"><i class="fa-solid fa-margin fa-table-list fa-fw"></i>Eliminar filas vacías</button>
        <button class="btn btn-primary index shadow-none w-100" onclick="execNoSuccess('removeEmptyColumns')"><i class="fa-solid fa-margin fa-table-columns fa-fw"></i>Eliminar columnas vacías</button>
        <button class="btn btn-primary index shadow-none w-100" onclick="execNoSuccess('exportSheet')"><i class="fa-solid fa-database fa-margin fa-fw"></i>Exportar hoja a formato JSON</button>

        <div class="btn-group d-flex" role="group">
          <button class="btn btn-primary index shadow-none half w-50" title="Aumenta proporcionalmente el tamaño de letra en la hoja" onclick="execNoSuccess('increaseFontSize')"><i class="fa-solid fa-margin fa-fw fa-arrows-up-to-line"></i>Font Size +</button>
          <button class="btn btn-primary index shadow-none w-50" title="Disminuye proporcionalmente el tamaño de letra en la hoja" onclick="execNoSuccess('decreaseFontSize')"><i class="fa-solid fa-margin fa-fw fa-arrows-down-to-line"></i>Font Size -</button>
        </div>
        <!--
        <div class="btn-group d-flex" role="group">
          <button class="btn btn-primary index shadow-none half w-50" title="Aumenta proporcionalmente el tamaño de letra en la hoja" onclick="execNoSuccess('formulaUnwrap')"><i class="fa-solid fa-greater-than-equal fa-margin fa-fw"></i>Formula W+</button>
          <button class="btn btn-primary index shadow-none w-50" title="Disminuye proporcionalmente el tamaño de letra en la hoja" onclick="execNoSuccess('formulaWrap')"><i class="fa-solid fa-less-than-equal fa-margin fa-fw"></i>Formula U-</button>
        </div>
        -->
        <button class="btn btn-primary index shadow-none w-100" title="Genera un identificador por cada celda seleccionada" onclick="execNoSuccess('uniqueIdentifier')"><i class="fa-solid fa-barcode fa-margin fa-fw"></i>Identificadores automáticos</button>

        <!--
        <button class="btn btn-primary index shadow-none w-100" onclick="execNoSuccess('convertirReferenciasAbsolutas')"><i class="fa-solid fa-margin fa-table-list fa-fw"></i>AA-FormulaReference</button>
        <button class="btn btn-primary index w-100 shadow-none" title="Crea una lista de usuarios del Google Workspace de Morph" onclick="swalConfirm('getDomainUsersList', 'Se ha creado una lista de usuarios.', 'Asegúrate de tener seleccionada la celda donde comenzará el listado antes de continuar.')"><i class="fa-solid fa-margin fa-users fa-fw"></i>Lista de miembros Morph</button>
        <button class="btn btn-primary btn-lg-gmt mt-1 mb-3"  onclick="swalConfirm('exportXML', 'El archivo se ha convertido correctamente.', 'Congelar', 'Una vez ejecutado no se puede detener. Confirma para continuar.')">EXPORTAR XML</button>
        <div class="btn-group d-flex" role="group">
        <button class="btn btn-primary index shadow-none half w-50" onclick="execNoSuccess('drawPalette')"><i class="fa-solid fa-margin fa-palette fa-fw"></i>Paleta Morph</button>
        <button class="btn btn-primary index shadow-none w-50" onclick="execDirect('colorMe')"><i class="fa-solid fa-margin fa-fill-drip fa-fw"></i>Color Morph</button>
        </div>
        <button class="btn btn-primary index shadow-none w-100" onclick="execNoSuccess('mergeColumns')"><i class="fa-solid fa-margin fa-circle-h fa-fw"></i>Unificar columnas con el mismo encabezado</button>
        <button class="btn btn-primary index shadow-none half w-50" title="Ajusta las filas al texto existente" onclick="execNoSuccess('autoResizeAllRows')"><i class="fa-solid fa-margin fa-fw fa-sliders"></i>Fit Filas</button>
        <button class="btn btn-primary index shadow-none w-50" title="Ajusta las columnas al texto existente" onclick="execNoSuccess('autoResizeAllCols')"><i class="fa-solid fa-margin fa-fw fa-sliders"></i>Fit Colms</button>
        <button class="btn btn-primary index shadow-none w-100" onclick="execNoSuccess('postLessons')"><i class="fa-solid fa-comments fa-margin fa-fw"></i>Enviar mensajes de Chat</button>
        -->

      </div>
    </div>
  </div>

  <div class="accordion-item">
    <h2 class="accordion-header" id="headingFiles">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFiles" aria-expanded="false" aria-controls="collapseFiles">
        Archivos y carpetas
      </button>
    </h2>
    <div id="collapseFiles" class="accordion-collapse collapse" aria-labelledby="headingFiles" data-bs-parent="#accordionExample">
      <div class="accordion-body mt-2 pb-2">

        <?!= HtmlService.createHtmlOutputFromFile('public/helpers/folderlist').getContent(); ?>

      </div>
    </div>
  </div>

  <div class="accordion-item">
    <h2 class="accordion-header" id="headingInteroperabilidad">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInteroperabilidad" aria-expanded="false" aria-controls="collapseInteroperabilidad">
        Interoperabilidad
      </button>
    </h2>
    <div id="collapseInteroperabilidad" class="accordion-collapse collapse" aria-labelledby="headingInteroperabilidad" data-bs-parent="#accordionExample">
      <div class="accordion-body mt-2 pb-3">

        <?!= HtmlService.createHtmlOutputFromFile('public/helpers/interoperabilidad').getContent(); ?>

      </div>
    </div>
  </div>

  <div class="accordion-item devAreaPermission" style="display: none;">
    <h2 class="accordion-header" id="headingEstCom">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEstCom" aria-expanded="false" aria-controls="collapseEstCom">
        Estilos complejos
      </button>
    </h2>
    <div id="collapseEstCom" class="accordion-collapse collapse" aria-labelledby="headingEstCom" data-bs-parent="#accordionExample">
      <div class="accordion-body mt-2 pb-3">

        <?!= HtmlService.createHtmlOutputFromFile('public/helpers/estilosComplejos').getContent(); ?>

      </div>
    </div>
  </div>

  <div class="accordion-item">
    <h2 class="accordion-header" id="headingDevelopment">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDevelopment" aria-expanded="false" aria-controls="collapseDevelopment">
        Desarrollo
      </button>
    </h2>
    <div id="collapseDevelopment" class="accordion-collapse collapse" aria-labelledby="headingDevelopment" data-bs-parent="#accordionExample">

      <div id="password_div">
        <div class="card bg-light border-0 border-top rounded-0 mt-2" >
          <div class="card-body">
            <label for="hidden_password" class="form-label"><i class="fa-solid fa-key fa-margin fa-fw fa-sizing"></i>Introduce una clave:</label>
            <div class="input-group flex-nowrap update rounded-pill">
              <input name="password" type="password" value="" class="input form-control shadow-none" id="hidden_password" required="true" onkeydown = "if (event.keyCode == 13) document.getElementById('hideSectionButton').click()"/>
              <span class="input-group-text" onclick="password_show_hide();">
                <i class="fas fa-eye fa-fw" id="show_eye"></i>
                <i class="fas fa-eye-slash d-none fa-fw" id="hide_eye"></i>
              </span>
            </div>
            <div id="invalid-developer" class="text-danger mt-2 collapse">asdf</div>
            <button class="btn btn-secondary btn-lg-gmt w-100 mt-2" id="hideSectionButton">Desbloquear</button>
          </div>
        </div>
      </div>

      <?!= HtmlService.createHtmlOutputFromFile('public/helpers/developer').getContent(); ?>

    </div>
  </div>


  <div class="accordion-item last">
    <h2 class="accordion-header" id="headingHelp">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHelp" aria-expanded="false" aria-controls="collapseHelp">
        Ayuda
      </button>
    </h2>
    <div id="collapseHelp" class="accordion-collapse collapse" aria-labelledby="headingHelp" data-bs-parent="#accordionExample">
      <div class="accordion-body mt-2">

        <div class="progress">
          <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width:<?= cellCounter() ?>%">
          <span class="justify-content-center d-flex position-absolute w-100"><?= cellCounter() ?>%</span></div>
        </div>

        <?!= HtmlService.createHtmlOutputFromFile('public/helpers/help').getContent(); ?>

      </div>
    </div>
  </div>

</div>

<!-- SCRIPT AREA DIVISION -->

<script> // Funciones relacionadas con el área de desarrollo y validación de contraseñas

var wsNames = JSON.parse("<?=JSON.stringify(wsNames)?>");

function userRolePermission() {
  var permission = JSON.parse("<?=JSON.stringify(permission)?>");
  var keysToIterate = ["formulaModPermission", "devAreaPermission"]; 

  for (var i = 0; i < keysToIterate.length; i++) {
    var property = keysToIterate[i];
    let x = document.getElementsByClassName(property);
    for (var j = 0; j < x.length; j++) {
      var classNames = x[j].className.split(' ');
      var showBlock = false;
      for (var k = 0; k < classNames.length; k++) {
        if (keysToIterate.includes(classNames[k]) && permission[classNames[k]]) {
          showBlock = true;
          break;
        }
      }
      x[j].style.display = showBlock ? 'block' : 'none';
    }
  }
  
}



function check_password () {
  btnLoading('#hideSectionButton', 'Validando...');
  var field = document.getElementById('hidden_password');
  var password = field.value;

  if (password == '') {
    $('#invalid-developer').html('<small>El campo no puede estar vacío.</small>').addClass("show");
    field.classList.add("is-invalid"); setTimeout(function(){validatePassword(field); $('#invalid-developer').removeClass("show").addClass("collapse") }, 3500);
    btnReset("#hideSectionButton");
  } else {

    if (permission[`devGlobalKeys`].includes(password)) {

      let x = document.getElementsByClassName("devAreaPermission");
      for (let i = 0; i < x.length; i++) {
          x[i].style.display = 'block';
      }

    } else if (permission[`manualKeys`].includes(password)) {

      let x = document.getElementsByClassName(password);
      password.style.display = 'block';

    } else {

        $('#invalid-developer').html('<small>La clave es incorrecta.</small>').addClass("show");
        field.classList.add("is-invalid"); setTimeout(function(){validatePassword(field);  $('#invalid-developer').removeClass("show").addClass("collapse") }, 3500);

    }

    btnReset("#hideSectionButton");
    $('#hidden_password').val('');

  }
}

function validatePassword(field) {
  field.classList.remove("is-invalid");
}

function password_show_hide() { // Función para el botón de ocultar/mostrar contraseña
  var x = document.getElementById("hidden_password");
  var show_eye = document.getElementById("show_eye");
  var hide_eye = document.getElementById("hide_eye");
  hide_eye.classList.remove("d-none");
  if (x.type === "password") {
    x.type = "text";
    show_eye.style.display = "none";
    hide_eye.style.display = "block";
  } else {
    x.type = "password";
    show_eye.style.display = "block";
    hide_eye.style.display = "none";
  }
}

</script> 

<script>

// Funciones relacionadas con los botones

function updateButtonClicked() {
  let updateLinkPage = document.getElementById("update-linkpage").checked;
  let keepSheetVisibility = document.getElementById("update-keepVisibility").checked;
  let updatePrefix = document.getElementById('updatePrefixID').value;
  let prefixAll = document.getElementById("prefix-all-switch").checked;
  let updateDebugReport = document.getElementById("update-debugReport").checked;

  let updateHistorico = document.getElementById("update-historico").checked;
  let updateBasic = document.getElementById("update-maindata").checked;
  let updateAI = document.getElementById("update-ai").checked;
  let updateAC = document.getElementById("update-ac").checked;

  let btnID = 'Superficies';
  var rowData = {
        updatePrefix,
        prefixAll,
        updateLinkPage,
        keepSheetVisibility,
        updateDebugReport,
        updateHistorico,
        updateBasic,
        updateAI,
        updateAC
      }
  if (updateLinkPage) {
    swalConfirm('morphCSUpdater', 'El cuadro se ha actualizado correctamente.', 'Se actualizará la hoja LINK en el proceso de actualización. Confirma para continuar.', btnID, rowData);
  } else {
    swalConfirm('morphCSUpdaterDirect', 'El cuadro se ha actualizado correctamente.', 'Una vez ejecutado no se puede detener. Confirma para continuar.', rowData);
  }
}
/*
function historicoButtonClicked() {
  let addToDesglosado = document.getElementById("historicoSupAddPlus").checked;

  if (addToDesglosado) {
    swalConfirmAdv('historicoDeSuperficies', e => {google.script.run.withSuccessHandler(swalsuccess('Se ha creado un punto temporal en el histórico.')).historicoDeSuperficies(1)}, 'Se creará un nuevo punto en la hoja Histórico CONSTRUIDAS.', 0);
  } else {
    swalConfirm('historicoDeSuperficies', 'Se ha creado un punto temporal en el histórico.', 'Se creará un nuevo punto en la hoja Histórico CONSTRUIDAS.', 0);
  }
}
*/
function formulaLogButtonClicked() {
  let formulaText = document.getElementById("formulaLogFormulaText").value;
  let sendToTemplate = document.getElementById("sendFormulaToTemplate").checked;
  var rowData = {
        formulaText,
        sendToTemplate
      }
  swalConfirm('formulaLogger', 'La fórmula ha quedado registrada.', 'Asegúrate de haber copiado la fórmula antigua en el área de texto y de tener seleccionada la celda modificada antes de continuar.', rowData);
}

$('#formulaDropperButton').click(function() {
  swaload();
  google.script.run.withSuccessHandler(function(data){
    let field = $('#formulaLogFormulaText');
    field.val(data);
    Swal.close();
  }).formulaDropper();
});

$('#mssUpdate').click(function() {
  let mssUpdateColumnReferenceText = document.getElementById("mssUpdateColRef").value;
  let mssUpdateAllCheck = document.getElementById("mssUpdateAll").checked;

  swalConfirm('bddcompuestos', 'Se ha creado un punto temporal en el histórico.', '¿Estás seguro que quieres actualizar el documento con Morph Spreadsheet System?', mssUpdateColumnReferenceText, mssUpdateAllCheck);
});

$('#mssUpdateAll').change(function() {
    if ($(this).prop('checked')) {
      $('#mssUpdateColRef').attr("disabled", true).val('');
    } else {
      $('#mssUpdateColRef').attr("disabled", false);
    }
});


</script>

<script>

// JQuery para el control HTML

$(document).ready(function() {
  $('.prefixUpdateClass').attr("disabled", true);
  $('.prefixUpdateClassColor').css('color', '#B0BEC5');
  $('.fittext').fitText();

});

$('#update-linkpage').change(function() {
    if ($(this).prop('checked')) {
      $(".updateLinkPageCollapse").collapse('show');
      $('.prefixUpdateClassColor').css('color', '#37474F');
      $('.prefixUpdateClass').attr("disabled", false);
      
    } else {
      $(".updateLinkPageCollapse").collapse('hide');
      $('.prefixUpdateClass').attr("disabled", true);
      $('.prefixUpdateClassColor').css('color', '#B0BEC5');
    }
});

$('#prefix-all-switch').change(function() {
    if ($(this).prop('checked')) {
      $('.prefixUpdateClassColor').css('color', '#B0BEC5');
    } else {
      $('.prefixUpdateClassColor').css('color', '#37474F');
    }
});



$('#rowsDeleteButton').click(function() {
  let rowValue = document.getElementById("rowsDeleteInput").value;
  execNoSuccess('deleteExcessiveRows', rowValue);
});

$('.optSpr').click(function() {
  scrollToPageCenter();
  var id = $(this).attr('id').substring(6);
  swalConfirm('optimizeSpreadsheet', 'El documento se ha optimizado, puedes comprobar su tamaño en la pestaña "Ayuda".', `Se analizarán las hojas que tengan más de ${id} filas y después podrás confirmar si deseas optimizar el documento.`, id);
});

$('#formulaImportButton, #formulaExportButton').click(function() {
  let formulaInteropSelectFileType = document.getElementById("formulaInteropSelectFileType").value;
  let formulaInteropAllDocument = document.getElementById("formulaInteropAllDocument").checked;
  let formulaInteropFormat = document.getElementById("formulaInteropFormat").checked;

  var rowData = {
        formulaInteropSelectFileType,
        formulaInteropAllDocument,
        formulaInteropFormat
      }
  
  let buttonId = $(this).attr('id');
  let buttonClicked; let confirmText;

  buttonId.includes('Import') ? buttonClicked = `Import` : buttonClicked = `Export`;
  confirmText = formulaInteropAllDocument ? `Se ${buttonClicked.toLowerCase()}arán únicamente las fórmulas correspondientes a la hoja actual.` : `Se ${buttonClicked.toLowerCase()}arán las fórmulas de toda la hoja de cálculo.`;
  swalConfirm(`formulaDatabase${buttonClicked}`, `Las fórmulas se han ${buttonClicked.toLowerCase()}ado correctamente.`, confirmText, rowData);
});

</script>

<script>

// Script to order buttons alphabetically (and add ult_class to last child)

'use strict';
const buttonContainer = document.getElementById('button-container');
const sortedButtons = [... buttonContainer.children].sort((buttonA, buttonB) => {
  const name1 = buttonA.innerText.toLowerCase();
  const name2 = buttonB.innerText.toLowerCase();
  if(name1 === name2){
    return 0;
  } else if(name1 < name2){
    return -1;
  } else {
    return 0;
  }
});
sortedButtons.forEach(button => buttonContainer.append(button));

$("#button-container").children().last().addClass("ult");

</script>

<script>





function checkReturn(arg) {
  if(arg === 'true') { return true; } else { return false; }
}

</script>

<script>

$(document).ready(function() {
  setTimeout(function(){removeFadeOut(document.getElementById('loading-spin'), 300)}, 300);
  userRolePermission();
  getSavedProperties();
  getSavedCSVImport();
  sctGetDropdownSheetnames(wsNames);
  sctGetSavedData();
})

document.getElementById('hideSectionButton').addEventListener("click", check_password);
document.getElementById('csUpdater').addEventListener("click", updateButtonClicked);

document.addEventListener('DOMContentLoaded',function(){
  const tooltips = document.querySelectorAll('[data-tooltip]');
  tooltips.forEach((item)=>{
      const text =item.dataset.tooltip;
      const title =item.dataset.tooltipTitle;
      const tooltip = document.createElement('div');
      item.addEventListener('mouseenter',(evt)=>{
          const cords = evt.target.getBoundingClientRect();
          tooltip.className= 'tooltip';
          tooltip.innerHTML=`<p>${text}</p>`; 
          document.body.appendChild(tooltip);
          tooltip.style.top=`${cords.y + cords.height + 10}px`;
          tooltip.style.left=`${cords.x + cords.width / 40}px`;
          
          setTimeout(() => {
              tooltip.classList.add('active')
          },20);
        
      });
      
      item.addEventListener('mouseleave',()=>{
          tooltip.classList.remove('active');
          setTimeout(() => {
            document.body.removeChild(tooltip)
          },250);
      });
  });
});

</script>

<?!= HtmlService.createHtmlOutputFromFile('public/helpers/swal').getContent(); ?>
<?!= HtmlService.createHtmlOutputFromFile('public/helpers/footer').getContent(); ?>

</body>
</html>
