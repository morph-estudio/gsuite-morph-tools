<html>
<head>
  <base target="_top">
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <?!= HtmlService.createHtmlOutputFromFile('public/helpers/header').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('public/main/stylesheet').getContent(); ?>

</head>

<body>

<?!= HtmlService.createHtmlOutputFromFile('public/helpers/navbar').getContent(); ?>

<div class="accordion-body mt-2">

  <div class="card mt-3 mb-1">
    <div class="card-header font-weight-bold" style="font-weight:bold">
      Configuración del cuadro
    </div>

    <div class="card-body ps-2 pe-2 pt-2 pb-2">

    <div class="mt-2 mb-2">
      <label for="export-select" class="form-label"><i class="fa-solid fa-tree-city fa-margin fa-fw"></i>Tipo de proyecto</label>
      <select class="form-select shadow-none" id="project-type" >
      </select>
    </div>

    <button id="cuadrosConfigCopyTemplate" class="btn btn-success btn-xl shadow-none border-0 w-100 centerScroll">Crear cuadro nuevo</button>

    </div>
  </div>

  <div class="card mt-2 mb-1">
    <div class="card-header font-weight-bold" style="font-weight:bold">
      Gestión de plantilla
    </div>

    <select id="selectOptions" class="form-select form-select-lg border-0 border-bottom rounded-0 mt-0 shadow-none">
      <option value="option1">Generar</option>
      <option value="option2">Traer desde plantilla</option>
      <!-- Agrega más opciones según sea necesario -->
    </select>

    <div class="ps-2 pe-2 pt-2 pb-1" style="border-bottom: 1px solid lightgray">
      <div class="form-check form-switch" >
        <input class="form-check-input shadow-none" type="checkbox" role="switch" id="overwrite-switch">
        <label class="form-check-label" for="overwrite-switch">Sobrescribir hojas<span data-bs-toggle="tooltip" data-bs-placement="right" title="Si existen hojas con el mismo nombre que la hoja de plantilla, ésta se sustituirá por la nueva. No selecciones esta opción si quieres mantener la hoja original"><i class="fa-regular fa-circle-question fa-questionstyle" style=""></i></span></label>
      </div>
    </div>

    <div class="card-body ps-2 pe-2 pt-2">

    <div class="mb-3">
      <div class="gen-container mb-1">

        <button id="cuadrosConfigSend" class="btn btn-primary btn-xl shadow-none border-0 w-100 centerScroll">Ejecutar</button>
      </div>

      <div class="d-flex">
        <button class="btn btn-outline-secondary btn-lg-gmt w-65 shadow-none buttonRepadding centerScroll" id="cuadrosConfigSave">Guardar</button>
        <button class="btn btn-outline-danger btn-lg-gmt w-35 shadow-none buttonRepadding ms-1 centerScroll" id="cuadrosConfigDelete">Borrar</button>
      </div>
    </div>

    <form id="configForm">
      <div class="form-group">
        <!-- Aquí se generan los switches y checkboxes para las hojas maestras y secundarias -->
        <div id="hojasConfig"></div>
      </div>
    </form>


    </div>
  </div>

</div>

<script>

const CuadrosConfig = {};

var templateSheetConfigObject = JSON.parse("<?=JSON.stringify(config)?>");
var savedConfiguration = JSON.parse("<?=JSON.stringify(savedProperties)?>");
var wsNames = JSON.parse("<?=JSON.stringify(wsNames)?>");

CuadrosConfig.openDialogActions = function(buttonSelected) {
  if (buttonSelected === 'cuadrosConfigSend') {

    var selectedOption = $('#selectOptions').val();
    var overwriteSwitch = $('#overwrite-switch').prop('checked');;
    
      var rowData = {
        "masterSheets": [],
        "secondarySheets": []
      };

      var switchState;
      var maestraObject;
      var checkboxState;
      var secundariaObject;

      // Introducir datos de los switch maestros en rowData
      templateSheetConfigObject.masterSheets.forEach(function(masterSheet) {
        switchState = $('#switch_' + masterSheet.name.replace(/ /g, "_")).is(':checked');
        maestraObject = {
          "name": masterSheet.name,
          "isTrue": switchState
        };
        rowData.masterSheets.push(maestraObject);
      });

      // Introducir datos de los checkboxes secundarios en rowData
      templateSheetConfigObject.secondarySheets.forEach(function(secondarySheet) {
        checkboxState = $('#checkbox_' + secondarySheet.name.replace(/ /g, "_")).is(':checked');
        secundariaObject = {
          "name": secondarySheet.name,
          "masterSheet": secondarySheet.masterSheet,
          "isTrue": checkboxState
        };
        rowData.secondarySheets.push(secundariaObject);
      });

    if (selectedOption === 'option1') {
      swalConfirm('mainGenerateTemplateSheets', 'El cuadro se ha configurado correctamente.', 'Una vez ejecutado no se puede detener. Confirma para continuar.', rowData, overwriteSwitch);
    } else if (selectedOption === 'option2') {
      swalConfirm('mainCopySheetFromTemplate', 'La acción se ha completado correctamente.', 'Una vez ejecutado no se puede detener. Confirma para continuar.', rowData, overwriteSwitch);
    }

  } else if (buttonSelected === 'cuadrosConfigCopyTemplate') {
    swalinfo('Esta función aún está en desarrollo.')
  }

}


</script>

<script> // DOM Init

$(document).ready(function() {
  var hojasConfig = $("#hojasConfig");

  // Generación dinámica de switches y checkboxes para las hojas maestras y secundarias
  templateSheetConfigObject.masterSheets.forEach(function(masterSheet) {
    var switchDivMaestra = $("<div></div>").addClass("form-check form-check-mae form-switch");
    var switchInputMaestra = $("<input>")
      .attr("type", "checkbox")
      .attr("id", "switch_" + masterSheet.name.replace(/ /g, "_"))
      .addClass("form-check-input form-check-input-mae shadow-none");

    var iconColor = getColorForIcon(masterSheet.name);

    var switchLabelMaestra = $("<label></label>")
      .attr("for", "switch_" + masterSheet.name.replace(/ /g, "_"))
      .addClass("form-check-label form-check-label-mae")
      .html(`<span data-bs-toggle="tooltip" data-bs-placement="right" title="${masterSheet.description}" >
      <i class="fa-solid fa-circle fa-questionstyle2" style="color: ${iconColor};"></i>
      </span><span>${masterSheet.name}</span>`)
    
    switchDivMaestra.append(switchLabelMaestra);
    switchDivMaestra.append(switchInputMaestra);

    hojasConfig.append(switchDivMaestra);

    templateSheetConfigObject.secondarySheets.forEach(function(secondarySheet) {
      if (secondarySheet.masterSheet === masterSheet.name) {
        var checkboxDivSecundaria = $("<div></div>").addClass("form-check form-check-sec");
        var checkboxInputSecundaria = $("<input>")
          .attr("type", "checkbox")
          .attr("id", "checkbox_" + secondarySheet.name.replace(/ /g, "_"))
          .addClass("form-check-input form-check-input-sec shadow-none")
          .prop("disabled", true);

        var iconColor = getColorForIcon(secondarySheet.name);

        var checkboxLabelSecundaria = $("<label></label>")
          .attr("for", "checkbox_" + secondarySheet.name.replace(/ /g, "_"))
          .addClass("form-check-label form-check-label-sec")
          .html(`<span data-bs-toggle="tooltip" data-bs-placement="right" title="${secondarySheet.description}" >
          <i class="fa-solid fa-circle fa-questionstyle2" style="color: ${iconColor};"></i>
          </span><span>${secondarySheet.name}</span>`)

        checkboxDivSecundaria.append(checkboxLabelSecundaria);
        checkboxDivSecundaria.append(checkboxInputSecundaria);

        hojasConfig.append(checkboxDivSecundaria);

        // Margen izquierdo de las checkboxes de hojas secundarias
        checkboxDivSecundaria.css("margin-left", "15px");

        // Evento para habilitar o deshabilitar los checkboxes hijos
        switchInputMaestra.on("change", function() {
          if ($(this).is(":checked")) {
            checkboxDivSecundaria.find('input[type="checkbox"]').prop("disabled", false);
          } else {
            checkboxDivSecundaria.find('input[type="checkbox"]').prop("disabled", true);
          }
        });
      }
    });
  });

  var projectTypeSelect = document.getElementById('project-type');

  // Iterate through projectTypes array and populate options
  templateSheetConfigObject.projectTypes.forEach(function(projectType) {
    var option = document.createElement('option');
    option.value = projectType.code; // Use the code as the value
    option.text = projectType.nombre; // Use the nombre as the displayed text
    projectTypeSelect.appendChild(option);
  });

  applySavedConfiguration();
});

// Función para aplicar colores a los switch en función del tabColor de su hoja maestra
function applySwitchStyles(masterSheet) {
  var switchInputMaestra = $("#switch_" + masterSheet.name.replace(/ /g, "_"));

  function updateSwitchStyle() {
    var isChecked = switchInputMaestra.is(":checked");
    var knobColor = isChecked ? masterSheet.tabColor : "white";
    var knobSvg = isChecked
      ? 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="-4 -4 8 8"><circle r="3" fill="#ffffff"/></svg>')
      : 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="-4 -4 8 8"><circle r="3" fill="' + masterSheet.tabColor + '"/></svg>');

    switchInputMaestra.css("border-color", masterSheet.tabColor);
    switchInputMaestra.css("background-color", knobColor);
    switchInputMaestra.css("background-image", 'url("' + knobSvg + '")');
  }

  // Aplicar el estilo personalizado al cargar la página
  updateSwitchStyle();

  toggleChildCheckboxes(switchInputMaestra);

  // Aplicar el estilo personalizado cuando cambie el estado del checkbox
  switchInputMaestra.on("change", function () {
    updateSwitchStyle();
    toggleChildCheckboxes(switchInputMaestra);
  });

  cambiarColorEtiqueta();
}

function styleSwitches() {
  templateSheetConfigObject.masterSheets.forEach(function(masterSheet) {
    applySwitchStyles(masterSheet);
  });
}

// Función para cambiar el color de la etiqueta según el estado del checkbox
function cambiarColorEtiqueta() {
    $('.form-check-input-sec').each(function() {
        var checkbox = $(this);
        var etiqueta = checkbox.siblings('.form-check-label-sec');

        if (checkbox.prop('disabled')) {
            etiqueta.css('color', 'lightgray');
        } else {
            etiqueta.css('color', '#666666'); // Cambiar 'black' por el color principal deseado
        }
    });
}

function getColorForIcon(hojaMaestraNombre) {
  if (wsNames.includes(hojaMaestraNombre)) {
    return "#64DD17";
  } else {
    return "lightgray";
  }
}

// Función para cambiar el estado del checkbox en función del estado de su switch maestro
function toggleChildCheckboxes(switchInputMaestra) {
  var checkboxDivSecundaria = switchInputMaestra.closest(".form-check-mae").nextUntil(".form-check-mae");
  if (switchInputMaestra.is(":checked")) {
    checkboxDivSecundaria.find('input[type="checkbox"]').prop("disabled", false);
  } else {
    checkboxDivSecundaria.find('input[type="checkbox"]').prop("disabled", true);
  }
}

// Función para recibir la señal del backend después de borrar las propiedades
function handlePropertiesRemoved() {
  applySavedConfiguration();
}

// Función para desactivar los checkboxes al borrar la configuración
function removeCheckedCheckboxes() {
  var inputs = document.querySelectorAll('[id^="switch_"], [id^="checkbox_"]');

  inputs.forEach(function(input) {
    if (input.type === "checkbox") {
      input.checked = false; // Restablecemos el estado de los checkboxes a "false"
    }
  });

  styleSwitches();
}

CuadrosConfig.afterButtonClicked = function(buttonId) {
  var rowData = {};
  var inputs = document.querySelectorAll('[id^="switch_"], [id^="checkbox_"]');

  inputs.forEach(function(input) {
    if (input.type === "checkbox") {
      rowData[input.id.replace(/(switch|checkbox)_/, "")] = input.checked;
    } else {
      rowData[input.id] = input.value;
    }
  });

  if (buttonId === 'cuadrosConfigSave') {
    swalConfirm('saveDataToDocumentProperties', 'Se ha guardado la configuración.', '¿Quieres guardar la actual configuración del cuadro?', rowData)
  } else if (buttonId === 'cuadrosConfigDelete') {
    swalConfirm('removeDataFromDocumentProperties', 'Se ha eliminado la configuración actual.', 'Se eliminará la configuración guardada.', rowData, null, null, removeCheckedCheckboxes);
  }
}

function applySavedConfiguration() {
  // alert(JSON.stringify(savedConfiguration))
  var inputs = document.querySelectorAll('[id*="switch_"], [id*="checkbox_"]');

  inputs.forEach(function(input) {
    var key = input.id.replace(/(switch_|checkbox_)/, ""); // Corrección aquí
    //alert(key)
    if (input.type === "checkbox") {
      // Asignar el estado del checkbox
      var value = savedConfiguration[key];
      if(value) { input.checked = value === "true" ? true : false; } else { input.checked = false }
    } else {
      // Si es un input de texto u otro tipo, se asigna el valor almacenado
      input.value = savedConfiguration[key] || "";
    }
  });

  styleSwitches();
}

$(document).ready(function() {
  google.script.run.fastInit(savedConfiguration);

  setTimeout(function(){removeFadeOut(document.getElementById('loading-spin'), 300)}, 250);

  $('#cuadrosConfigSend').on('click', function () { CuadrosConfig.openDialogActions($(this).attr('id')); });
  $('#cuadrosConfigCopyTemplate').on('click', function () { CuadrosConfig.openDialogActions($(this).attr('id')); });

  $('#cuadrosConfigSave').on('click', function () { CuadrosConfig.afterButtonClicked('cuadrosConfigSave'); });
  $('#cuadrosConfigDelete').on('click', function () { CuadrosConfig.afterButtonClicked('cuadrosConfigDelete'); });
  $('.form-check-input-mae').change(function() { cambiarColorEtiqueta(); });

});

</script>

<?!= HtmlService.createHtmlOutputFromFile('public/helpers/swal').getContent(); ?>
<?!= HtmlService.createHtmlOutputFromFile('public/helpers/footer').getContent(); ?>

</body>
</html>
