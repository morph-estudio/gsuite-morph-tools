<html>
<head>
  <base target="_top">
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <?!= HtmlService.createHtmlOutputFromFile('html/helpers/header').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('html/stylesheet').getContent(); ?>

</head>

<body>

<?!= HtmlService.createHtmlOutputFromFile('html/helpers/navbar').getContent(); ?>

<div class="bodyPadding mt-3">

  <p>Morph Document Studio te permite crear archivos en masa a partir de plantillas con DOCS y SLIDES.</p>
  <div class="d-flex mb-3">
    <object data="https://mocarabes.com/wp-content/uploads/morph/google-sheets-icon.svg" class="docsicons"> </object>
    <i class="fa-solid fa-arrow-right fa-compatible"></i>
    <object data="https://mocarabes.com/wp-content/uploads/morph/google-docs-icon.svg" class="docsicons"> </object>
    <object data="https://mocarabes.com/wp-content/uploads/morph/google-slides-icon.svg" class="docsicons"> </object>
    <i class="fa-solid fa-wand-magic-sparkles fa-compatible"></i>
  </div>

</div>

<div class="accordion" id="accordionExample">

  <div class="accordion-item">
    <h2 class="accordion-header" id="headingOne">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
        Inicio
      </button>
    </h2>
    <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
      <div class="accordion-body">

        <?!= HtmlService.createHtmlOutputFromFile('html/helpers/form-ds1').getContent(); ?>

      </div>
    </div>
  </div>

  <div class="accordion-item">
    <h2 class="accordion-header" id="headingTwo">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
        Crear documentos
      </button>
    </h2>
    <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionExample">
      <div class="accordion-body">

      <?!= HtmlService.createHtmlOutputFromFile('html/helpers/form-ds2').getContent(); ?>

      </div>
    </div>
  </div>

  <div class="accordion-item">
    <h2 class="accordion-header" id="headingThree">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
        Enviar e-mails
      </button>
    </h2>
    <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#accordionExample">
      <div class="accordion-body">

      <?!= HtmlService.createHtmlOutputFromFile('html/helpers/form-ds3').getContent(); ?>

      </div>
    </div>
  </div>

  <div class="accordion-item">
    <h2 class="accordion-header" id="headingFour">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
        Finalizar
      </button>
    </h2>
    <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#accordionExample">
      <div class="accordion-body">

        <?!= HtmlService.createHtmlOutputFromFile('html/helpers/help').getContent(); ?>

      </div>
    </div>
  </div>

  <div class="accordion-item ultimo">
    <h2 class="accordion-header" id="headingFive">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFive" aria-expanded="false" aria-controls="collapseFive">
        Ayuda
      </button>
    </h2>
    <div id="collapseFive" class="accordion-collapse collapse" aria-labelledby="headingFive" data-bs-parent="#accordionExample">
      <div class="accordion-body">

        <?!= HtmlService.createHtmlOutputFromFile('html/helpers/help').getContent(); ?>

      </div>
    </div>
  </div>

  </div>

<form>
    <div class="d-flex justify-content-center pt-3 bodyPadding">
      <button class="btn btn-primary btn-lg" id="mainButton">Crear documentos</button>
    </div>

</form>
  




<!-- Flexbox container for aligning the toasts -->

<div class="toast-container mt-3">

  <div id="errorNotFunctions" class="toast shadow-sm" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      
      <strong class="me-auto" style="color:#FF9800">Advertencia</strong>
      <img src="https://morphestudio.es/wp-content/uploads/2018/10/logo-morph-estudio.png" class="rounded me-2" width="30" heigth="auto">
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body">
      No se ha activado ninguna función de Morph Document Studio.
    </div>
  </div>

  <div id="errorNotFields" class="toast shadow-sm" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      
      <strong class="me-auto" style="color:#FF9800">Advertencia</strong>
      <img src="https://morphestudio.es/wp-content/uploads/2018/10/logo-morph-estudio.png" class="rounded me-2" width="30" heigth="auto">
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body">
      Revisa todos los campos obligatorios para continuar.
    </div>
  </div>

</div>





<script>

function afterButtonClicked() {

  var dsActivate = document.getElementById("ds-activate").checked;
  var emailActivate = document.getElementById("email-activate").checked;
  var fieldsToValidate;

  if (dsActivate) {
    fieldsToValidate = document.querySelectorAll("#userform input, #userform2 input, #userform select");
  } else if (emailActivate) {
    fieldsToValidate = document.querySelectorAll("#userform3 input, #userform3 select, #userform2 input");
  }

  if (dsActivate || emailActivate) {

    if(validate(fieldsToValidate)) {
      
      var tplID = document.getElementById("template-id");
      var destFolder = document.getElementById("destination-folder");
      var fileName = document.getElementById("file-name");
      var exportFMT = document.getElementById("export-format");
      var permCheck1 = document.getElementById("permission-1");
      var permCheck2 = document.getElementById("permission-2");
      var permCheck3 = document.getElementById("permission-3");
      var numSwitch = document.getElementById("numeration-switch");
      var greenCells = document.getElementById("green-cells");

      var emailField = document.getElementById("email-field");
      var emailSpecific = document.getElementById("email-specific");
      var emailSender = document.getElementById("email-sender");
      var emailSubject = document.getElementById("email-subject");
      var emailBCC = document.getElementById("email-bcc");
      var emailReplyTo = document.getElementById("email-replyto");
      var emailMessage = tinymce.activeEditor.getContent();
      var emailAttach = document.getElementById("email-addblob");
      var emailAttachField = document.getElementById("email-blob-field");

      var rowData = {
            dsActivate: dsActivate,
            emailActivate: emailActivate,
            greenCells: greenCells.checked,
            templateID: tplID.value,

            destFolder: destFolder.value,
            fileName: fileName.value,
            exportFormat: exportFMT.value,
            permission1: permCheck1.checked,
            permission2: permCheck2.checked,
            permission3: permCheck3.checked,
            numSwitch: numSwitch.checked,

            emailField: emailField.value,
            emailSpecific: emailSpecific.value,
            emailSender: emailSender.value,
            emailSubject: emailSubject.value,
            emailBCC: emailBCC.value,
            emailReplyTo: emailReplyTo.value,
            emailMessage: emailMessage,
            emailAttach: emailAttach.checked,
            emailAttachField: emailAttachField.value,
          };

      swaload();
      google.script.run.withSuccessHandler(e => {swalsuccess('Se han generado todos los archivos.'), afterSubmit2(e)}).withFailureHandler(swalerror).documentStudio(rowData);

    } else{ $("#errorNotFields").toast("show"); }

  } else{ $("#errorNotFunctions").toast("show"); }

}

function afterButtonClickedMarkers() {

  var fieldsToValidate = document.querySelectorAll("#userform2 input");

  if(validate(fieldsToValidate)) {

    var tplID = document.getElementById("template-id");
    var greenCells = document.getElementById("green-cells");
    var purgeMarkers = document.getElementById("purge-markers").checked;

    var rowData = {
      templateID: tplID.value,
      greenCells: greenCells.checked,
      purgeMarkers: purgeMarkers,
    };

    if (purgeMarkers) {
      swalConfirm('getMarkers', 'Los marcadores se han actualizado en la hoja.', 'Purgar', 'Si seleccionas purgar, se eliminarán los datos de las columnas que no correspondan con algún marcador de la plantilla. Confirma para continuar.', rowData);
    } else{
      swaload();
      google.script.run.withSuccessHandler(e => {swalsuccess('Los marcadores se han actualizado en la hoja.'), afterSubmit(e)}).withFailureHandler(swalerror).getMarkers(rowData);
    }

  } else{ $("#errorNotFields").toast("show"); }

}

function afterSubmit(e) {
  clearFields(["template-id", "destination-folder", "file-name"]);
  var exportFMT = document.getElementById("export-format");
  exportFMT.value = "PDF";
  //$("#successNotification").toast("show");
}

function clearFields(feilds) {
  feilds.forEach(function(feild){
    var el = document.getElementById(feild);
    el.value = "";
  });
}

function validate(fieldsToValidate) {

  Array.prototype.forEach.call(fieldsToValidate, function(el){
    if (el.checkValidity()){
      el.classList.remove("is-invalid");
    } else{
      el.classList.add("is-invalid");
    }
  });

  return Array.prototype.every.call(fieldsToValidate,function(el){
    return el.checkValidity();
  });
}

document.getElementById("mainButton").addEventListener("click", afterButtonClicked);
document.getElementById("markerButton").addEventListener("click", afterButtonClickedMarkers);

</script>


<script>

  function afterSidebarLoads(){
    setTimeout(function(){removeFadeOut(document.getElementById('loading-spin'), 300)}, 50);
  }
</script>

<?!= HtmlService.createHtmlOutputFromFile('html/helpers/swal').getContent(); ?>
<?!= HtmlService.createHtmlOutputFromFile('html/helpers/footer').getContent(); ?>


</body>
</html>
