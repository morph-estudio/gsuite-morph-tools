<html>
<head>
  <base target="_top">
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <?!= HtmlService.createHtmlOutputFromFile('public/helpers/header').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('public/main/stylesheet').getContent(); ?>

  <script src="https://cdn.tiny.cloud/1/c6gsjn35dtkdhm0zan0ftyao7fe0lr3ye6ocltbbu4bj46em/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
  <script>
    tinymce.init({
      selector: 'textarea#editor',
      plugins: 'lists',
      toolbar_mode: 'wrap',
      placeholder: 'En el asunto y mensaje puedes utilizar {{marcadores}} para personalizar los emails.',
      skin: 'bootstrap',
      height : "300",
      plugins: 'lists, link, image, media',
      toolbar: 'bold italic underline forecolor bullist numlist | link emoticons removeformat undo',
      menubar: false,
      entity_encoding: "raw",
      placeholder_attrs: "color: #888",
      setup: function (editor) {
          editor.on('init', function (e) {
              if (typeof dataExtracted['Email Message'] !== 'undefined') var emailMessage = dataExtracted['Email Message'];
              editor.setContent(emailMessage);
          });
      }
      });
  </script>

</head>

<body>

<?!= HtmlService.createHtmlOutputFromFile('public/helpers/navbar').getContent(); ?>

<!--   <div class="background-grey">

  <p>Morph Document Studio te permite crear archivos en masa a partir de plantillas con DOCS y SLIDES.</p> 
  <div class="d-flex pt-3 pb-3 mx-auto accordion-body">
    <object data="https://mocarabes.com/wp-content/uploads/morph/google-sheets-icon.svg" class="docsicons"> </object>
    <i class="fa-solid fa-arrow-right fa-compatible"></i>
    <object data="https://mocarabes.com/wp-content/uploads/morph/google-docs-icon.svg" class="docsicons"> </object>
    <object data="https://mocarabes.com/wp-content/uploads/morph/google-slides-icon.svg" class="docsicons"> </object>
    <i class="fa-solid fa-wand-magic-sparkles fa-compatible"></i>
  </div> 

</div> -->

<div class="accordion" id="accordionExample">

  <div class="accordion-item">
    <h2 class="accordion-header" id="headingOne">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
        Inicio
      </button>
    </h2>
    <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
      <div class="accordion-body">

        <div class="d-flex pt-1 pb-3 mx-auto">
          <img src='https://mocarabes.com/wp-content/uploads/morph/google-sheets-icon.svg' height='auto' width='50' />
          <i class="fa-solid fa-arrow-right fa-compatible"></i>
          <img src='https://mocarabes.com/wp-content/uploads/morph/google-docs-icon.svg' height='auto' width='50' />
          <img src='https://mocarabes.com/wp-content/uploads/morph/google-slides-icon.svg' height='auto' width='50' />
          <i class="fa-solid fa-wand-magic-sparkles fa-compatible"></i>
        </div>

        <!--<div class="d-flex pt-1 pb-3 mx-auto">
          <object type="image/svg+xml" data="https://svgshare.com/i/pbo.svg" class="docsicons"> </object>
          <i class="fa-solid fa-arrow-right fa-compatible"></i>
          <object type="image/svg+xml" data="https://mocarabes.com/wp-content/uploads/morph/google-docs-icon.svg" class="docsicons"> </object>
          <object type="image/svg+xml" data="https://mocarabes.com/wp-content/uploads/morph/google-slides-icon.svg" class="docsicons"> </object>
          <i class="fa-solid fa-wand-magic-sparkles fa-compatible"></i>
        </div>-->



        <div>
          <!--<form autocomplete="off"> QUITAR FORM-->
          <form novalidate>
            <div id="userform2">
            
              <div class="mb-4 mt-2">
                <label for="template-id" class="form-label"><i class="fa-regular fa-margin fa-note-sticky"></i>URL/ID Plantilla</label>
                <input type="text" class="form-control shadow-none" id="template-id" placeholder="ej: https://docs.google.com/document/d/1Gs4Gd4JtVMrI-nu6ELZtS71kebUU9CN3II2Xz5-Q2F8/edit?usp=sharing" aria-describedby="template-id-help" required>
                  <div class="invalid-feedback">
                  Introduce una URL/ID correcta.
                  </div>
                  <div id="template-id-help" class="form-text mt-2">Debe ser un archivo <b>docs</b> o <b>slides</b> y contener marcadores <b>{{marker}}</b>.</div>
              
                  <div class="form-check form-switch mt-3">
                    <input class="form-check-input shadow-none" type="checkbox" onclick="document.getElementById('template-id').disabled = this.checked;document.getElementById('destination-folder').disabled = this.checked" role="switch" id="green-cells" >
                    <label class="form-check-label" for="green-cells">Usar celdas verdes</label>
                  </div>

                  <div class="mt-4 mb-3">
                  <h3 class="menu-h3">Marcadores</h3>
                  <p>Obtener o actualizar en un clic los marcadores de la plantilla.</p>
                  </div>

                  <div class="form-check form-switch">
                    <input class="form-check-input shadow-none" type="checkbox" role="switch" id="purge-markers" >
                    <label class="form-check-label" for="purge-markers">Purgar marcadores obsoletos</label>
                  </div>

                  <button class="btn btn-secondary btn-lg-gmt w-100 mt-2" id="markerButton">Actualizar marcadores</button>

              </div>


            
            </div>
          </form>
        </div>



      </div>
    </div>
  </div>

  <div class="accordion-item">
    <h2 class="accordion-header" id="headingTwo">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
        Crear documentos
      </button>
    </h2>
    <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionExample">
      <div class="accordion-body mb-2">



        <div>
            <!--<form autocomplete="off"> QUITAR FORM-->
          <form novalidate>
            
            <div id="userform">
              <div class="hideWhenBothSwitchOff">
                <label class="switch mt-2">
                <input class="form-check-input" type="checkbox" role="switch" id="ds-activate" data-bs-toggle='collapse' data-bs-target='#dsForm, #all-documents-div' aria-expanded="false" aria-controls="dsForm">
                <div class="slider round">
                  <span class="on">ACTIVADO</span>
                  <span class="off">DESACTIVADO</span>
                </div>
                </label>
              </div>

              <div id="dsForm" aria-expanded="false" class="collapse" >
              
                <div class="mb-3 mt-4">
                  <label for="destination-folder" class="form-label"><i class="fa-regular fa-folder fa-margin fa-fw"></i>URL/ID Carpeta de destino</label>
                  <input type="text" class="form-control shadow-none" id="destination-folder" placeholder="ej: https://drive.google.com/drive/folders/1DHirb56iLf-T_n6Idq2MP8f8Ok765JuZ?usp=sharing" aria-describedby="destination-folder-help">
                    <div class="invalid-feedback">
                    Introduce una URL/ID correcta.
                    </div>
                  <div id="destination-folder-help" class="form-text mt-2">Si dejas el campo en blanco se creará una nueva carpeta en <b>Mi Unidad</b>.</div>
                </div>
                
                <div class="mb-4 mt-4">
                  <label for="file-name" class="form-label"><i class="fa-regular fa-pen-to-square fa-margin fa-fw"></i>Nombre de archivo</label>
                  <input type="text" class="form-control shadow-none" id="file-name" required>
                    <div class="invalid-feedback">
                    Introduce un nombre válido.
                    </div>
                  <div id="destination-folder-help" class="form-text mt-2">Puedes incluir cualquiera de los <b>{{marcadores}}</b> disponibles.</div>
                
                  <div class="form-check form-switch mt-3">
                    <input class="form-check-input shadow-none" type="checkbox" role="switch" id="numeration-switch">
                    <label class="form-check-label" for="numeration-switch">Añadir autonumeración</label>
                  </div>
                </div>
                
                <div class="mb-4">
                  <label for="export-select" class="form-label"><i class="fa-solid fa-file-export fa-margin fa-fw"></i>Formato de exportación</label>
                  <select class="form-select shadow-none" id="export-format" >
                    <option value="PDF">PDF</option>
                    <option value="KEEP">Mantener formato</option>
                  </select>
                </div>
                
                <div class="mb-3">

                  <label for="destination-folder" class="form-label"><i class="fa-solid fa-share-from-square fa-margin fa-fw"></i>Permisos de archivo</label>
                  <div class="form-check mt-2">
                    <input class="form-check-input shadow-none" type="radio" name="file_permission" id="permission-1" checked>
                    <label class="form-check-label" for="permission-1">
                      Restringido
                    </label>
                  </div>

                  <div class="form-check">
                    <input class="form-check-input shadow-none" type="radio" name="file_permission" id="permission-2" >
                    <label class="form-check-label"  for="permission-2">
                      Architecture Meets Engineering SL
                    </label>
                  </div>

                  <div class="form-check mt-2">
                    <input class="form-check-input shadow-none" type="radio" name="file_permission" id="permission-3" >
                    <label class="form-check-label"  for="permission-3">
                      Cualquier persona con el enlace
                    </label>
                  </div>

                </div>

              </div>
            </div>
          
          </form>
        </div>



      </div>
    </div>
  </div>

  <div class="accordion-item">
    <h2 class="accordion-header" id="headingThree">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
        Enviar emails
      </button>
    </h2>
    <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#accordionExample">
      <div class="accordion-body mb-2">


        <div>

        <!--<form autocomplete="off"> QUITAR-->
          <form novalidate>

            <div id="userform3">

              <div class="hideWhenBothSwitchOff">
                <label class="switch mt-2">
                <input class="form-check-input" type="checkbox" role="switch" id="email-activate" data-bs-toggle='collapse' data-bs-target='#emailForm, #all-emails-div' aria-expanded="true" aria-controls="emailForm">
                <div class="slider round">
                  <span class="on">ACTIVADO</span>
                  <span class="off">DESACTIVADO</span>
                </div>
                </label>
              </div>

                <div id="emailForm" aria-expanded="false" class="collapse">

                  <!-- Basic fields -->

                  <label for="email-field" class="form-label mt-4">Columna de emails</label>
                  <div class="d-flex flex-row align-items-baseline">
                    <select id="email-field" class="form-select shadow-none" aria-describedby="email-field-help"></select>
                    <button id="btn-refresh-1" type="button" class="btn-refresh" onclick="refreshButtonPush()"><i id="fa-sync-1" class="fa-solid fa-rotate-right"></i></button>
                  </div>
                    <div id="email-field-help" class="form-text mt-2">Selecciona la columna donde se encuentran las direcciones email.</div>

                  <label for="email-specific" class="form-label mt-3">CC (enviar copias del email)</label>
                  <input type="text" class="form-control shadow-none" id="email-specific" placeholder="ej: gestoria@morphestudio.es" aria-describedby="email-specific-help">
                    <div id="email-specific-help" class="form-text mt-2">Para enviar copias a varias personas separa los emails con comas.</div>
                    <div class="invalid-feedback">Introduce un email correcto.</div>

                  <label for="email-sender" class="form-label mt-3">Nombre del remitente</label>
                  <input type="text" class="form-control shadow-none" id="email-sender" placeholder="ej: Érika Sánchez">
                    <div class="invalid-feedback">El nombre no tiene un formato válido.</div>

                  <label for="email-subject" class="form-label mt-3">Asunto</label>
                  <input type="text" class="form-control shadow-none" id="email-subject">
                    <div class="invalid-feedback">El asunto no tiene un formato válido.</div>

                  <!-- More fields -->

                  <div class="form-check form-switch mt-3 mb-1">
                    <label class="form-check-label shadow-none" for="email-more">Rellenar otros campos</label>
                    <input class="form-check-input" type="checkbox" role="switch" id="email-more" data-bs-toggle='collapse' data-bs-target='#emailMore' aria-expanded="false" aria-controls="emailMore">
                  </div>

                  <div id="emailMore" aria-expanded="false" class="collapse">

                    <label for="email-bcc" class="form-label mt-3">BCC (copias ocultas)</label>
                    <input type="text" class="form-control shadow-none" id="email-bcc" aria-describedby="email-bcc-help">
                      <div id="email-bcc-help" class="form-text mt-2">Blind Carbon Copy (BCC) es una copia que se envía a destinatarios ocultos.</div>
                      <div class="invalid-feedback">Introduce una ID correcta.</div>

                    <label for="email-replyto" class="form-label mt-3">Reply-to Address</label>
                    <input type="text" class="form-control shadow-none" id="email-replyto" aria-describedby="email-replyto-help">
                      <div id="email-replyto-help" class="form-text mt-2">Correo personalizado al que responderán los destinatarios.</div>
                      <div class="invalid-feedback">Introduce una ID correcta.</div>

                  </div>

                  <!-- Tinymce -->

                  <div class="mb-4">
                    <!--Bootstrap classes arrange web page components into columns and rows in a grid -->
                    <div class="row justify-content-md-center">
                      <label for="editor" class="form-label mt-3">Mensaje</label>
                      <div class="col-md-12 col-lg-8">
                          <div class="form-group">
                              <textarea id="editor" type="textarea#editor" ></textarea>
                          </div>
                      </div>
                    </div>
                  </div>

                  <!-- Add Attachment -->

                  <div class="form-check form-switch mt-3">
                    <input class="form-check-input shadow-none" type="checkbox" role="switch" id="email-addblob" data-bs-toggle='collapse' data-bs-target='#emailBlob' aria-controls="emailBlob">
                    <label class="form-check-label" for="email-addblob">Añadir documento adjunto</label>
                  </div>

                  <div id="emailBlob" class="collapse" >

                    

                  <div class="d-flex flex-row align-items-baseline">
                    <select id="email-blob-field" class="form-select shadow-none mt-3" aria-describedby="email-blob-field-help"></select>
                    <button id="btn-refresh-2" type="button" class="btn-refresh" onclick="refreshButtonPush()"><i id="fa-sync-2" class="fa-solid fa-rotate-right"></i></button>
                  </div>

                    <div id="email-blob-field-help" class="form-text mt-2">Selecciona la columna donde se encuentran los LINKS de archivos.</div>

                </div>

              </div>

            </div>
          </form>

        </div>


      </div>
    </div>
  </div>

  <div class="accordion-item last">
    <h2 class="accordion-header" id="headingFour">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
        Finalizar
      </button>
    </h2>
    <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#accordionExample">
      <div class="accordion-body">

        <!-- FINALIZAR -->

        <div>
          <form novalidate> <!--<form autocomplete="off"> QUITAR -->
            <div id="userform3">


              <div class="mb-4">
                <label class="form-label mt-2">Finalizar configuración</label>
                <p>Revisa que toda la configuración esté correcta y presiona el botón <b>Ejecutar</b>. El tiempo de ejecución dependerá del la cantidad de filas y marcadores. La herramienta está en fase de pruebas, por lo que se podrían generar errores.</p>
              </div>

              <div class="hideWhenBothSwitchOff mb-4">
                <div id="hideWhenBothSwitchOff" aria-expanded="false" class="collapse">
                  <label class="form-label mt-1">Más opciones</label>
                  <p>Ejecutar en todas las filas o solo cuando estén vacías las celdas en <b>[DS] File-links</b> o <b>[DS] Email-links</b>.</p>
                </div>
                

                <div id="all-documents-div" aria-expanded="false" class="collapse">
                  <div class="form-check mt-2 mb-2">
                    <input class="form-check-input shadow-none" id="all-documents" type="checkbox" >
                    <label class="form-check-label" for="all-documents">
                      Generar todos los documentos
                    </label>
                  </div>
                </div>

                <div id="all-emails-div" aria-expanded="false" class="collapse">
                  <div class="form-check">
                    <input class="form-check-input shadow-none" id="all-emails" type="checkbox">
                    <label class="form-check-label" for="all-emails">
                      Enviar todos los emails
                    </label>
                  </div>
                </div>
              </div>

              <div id="finalButtons">
                <div class="d-flex">
                  <button class="btn btn-outline-secondary btn-lg-gmt w-65 shadow-none pb-1" id="saveButton">Guardar</button>
                  <button class="btn btn-outline-danger btn-lg-gmt w-35 shadow-none ms-1 pt-1 pb-1" id="deleteButton" onclick="swalConfirm('deleteDsConfiguration', 'Se ha eliminado la configuración', 'Se eliminará la configuración guardada.')">Borrar</button>
                </div>
                  <button class="btn btn-primary btn-xl w-100 shadow-none mt-1" id="mainButton">Ejecutar</button>
              </div>

              <div class="toast-div">
                <div id="errorNotFunctions" class="toast fade hide shadow-sm w-100" role="alert" aria-live="assertive" aria-atomic="true">
                  <div class="toast-header">
                    <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Warning:"><use xlink:href="#exclamation-triangle-fill"/></svg>
                    <strong class="me-auto">Advertencia</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                  </div>
                  <div class="toast-body">
                    No se ha activado ninguna de las funciones de Morph Document Studio.
                  </div>
                </div>

                <div id="errorNotFields" class="toast fade hide shadow-sm w-100" role="alert" aria-live="assertive" aria-atomic="true">
                  <div class="toast-header">
                    <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Warning:"><use xlink:href="#exclamation-triangle-fill"/></svg>
                    <strong class="me-auto">Advertencia</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                  </div>
                  <div class="toast-body">
                    Revisa todos los campos obligatorios para continuar.
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div> <!-- Div End -->

      </div>
    </div>
  </div>

</div>


<script>
  let data = JSON.parse("<?=JSON.stringify(dsProperties)?>");
  let headerDropdownValues = JSON.parse("<?=JSON.stringify(headerDropdownValues)?>");
  let dataExtracted = data;
  //alert(JSON.stringify(dataExtracted))
</script>

<script type="text/javascript">

function afterSidebarLoads(){
  afterDropDrownArrayReturned(headerDropdownValues);
}

function refreshButtonPush(){
  google.script.run.withSuccessHandler(afterDropDrownArrayReturned).headerDropdownValues();
}

function addDropdownElements(arrayOfArrays, field) {
  //alert(arrayOfArrays)
  arrayOfArrays.forEach(function(r){
    let option = document.createElement("option");
    option.textContent = r[0];
    field.appendChild(option);
  });

  if (typeof dataExtracted['Email Field'] !== 'undefined') var emailField = document.getElementById("email-field").value = dataExtracted['Email Field'];
  if (typeof dataExtracted['Email Attach Field'] !== 'undefined') var emailAttachField = document.getElementById("email-blob-field").value = dataExtracted['Email Attach Field'];
}

function afterDropDrownArrayReturned(arrayOfArrays){
  //alert(headerDropdownValues)
  let emailField = document.getElementById("email-field");
  emailField.innerHTML = "";
  addDefaultChild(emailField, 'Selecciona campo email');
  addDropdownElements(filterDropdownValues(arrayOfArrays, 'email'), emailField)
  let emailBlobField = document.getElementById("email-blob-field");
  emailBlobField.innerHTML = "";
  addDefaultChild(emailBlobField, 'Selecciona campo adjuntos');
  addDropdownElements(arrayOfArrays, emailBlobField);
  $('#fa-sync-1, #fa-sync-2').removeClass("fast-spin");
}

function addDefaultChild(field, text) {
  let option = document.createElement("option");
  option.text = text;
  option.value = '0';
  field.appendChild(option);
}

function getDropdownSavedFields() {
}

function filterDropdownValues(filterHeaderValues, filter) {
  if (filter) {
    // Filtrar los valores que contienen la palabra "email" (case insensitive)
    const filteredValues = filterHeaderValues.filter(row => {
      return row.some(cell => {
        return cell.toString().toLowerCase().includes(filter);
      });
    });

    return filteredValues;
  } else {
    // Si no se proporciona un filtro, devolver los valores originales sin filtrar
    return filterHeaderValues;
  }
}

function getSavedProperties() {

  setTimeout(function(){removeFadeOut(document.getElementById('loading-spin'), 300)}, 600);

  $(document).ready(function() {
    $('#dsForm').collapse($('#ds-activate').prop('checked') ? "show" : "hide");
    $('#all-documents-div').collapse($('#ds-activate').prop('checked') ? "show" : "hide");
    $('#emailForm').collapse($('#email-activate').prop('checked') ? "show" : "hide");
    $('#all-emails-div').collapse($('#email-activate').prop('checked') ? "show" : "hide");
    $('#emailBlob').collapse($('#email-addblob').prop('checked') ? "show" : "hide");

    document.getElementById('template-id').disabled = document.getElementById('green-cells').checked;
    document.getElementById('destination-folder').disabled = document.getElementById('green-cells').checked;

    $('#ds-activate').change(function() { 
        $('#dsForm').collapse('toggle');
        $('#all-documents-div').collapse('toggle');
    });
    $('#email-activate').change(function() { 
        $('#emailForm').collapse('toggle');
        $('#all-emails-div').collapse('toggle');
    });
    $('#email-addblob').change(function() { 
        $('#emailBlob').collapse('toggle');
    });

    $(document).ready(function() {
            var checks = $("#ds-activate, #email-activate");
            if (checks.filter(':checked').length == 0) {
                $('#hideWhenBothSwitchOff').hide();
            } else {
                $('#hideWhenBothSwitchOff').show();
            }
        $('.hideWhenBothSwitchOff').click(function () {
            var checks = $("#ds-activate, #email-activate");
            if (checks.filter(':checked').length == 0) {
                $('#hideWhenBothSwitchOff').hide();
            } else {
                $('#hideWhenBothSwitchOff').show();
            }
        });
    });
  });

  document.getElementById("ds-activate").checked = checkReturn(dataExtracted['DS Activate']);
  document.getElementById("email-activate").checked = checkReturn(dataExtracted['Email Activate']);

  if (typeof dataExtracted['Template Link'] !== 'undefined') document.getElementById("template-id").value = dataExtracted['Template Link'];
  if (typeof dataExtracted['Green Cells'] !== 'undefined') document.getElementById("green-cells").checked = checkReturn(dataExtracted['Green Cells']);

  if (typeof dataExtracted['Destination Folder'] !== 'undefined') var destinationFolder = document.getElementById("destination-folder").value = dataExtracted['Destination Folder'];
  if (typeof dataExtracted['Filename'] !== 'undefined') var fileName = document.getElementById("file-name").value = dataExtracted['Filename'];
  if (typeof dataExtracted['Export Format'] !== 'undefined') var exportFormat = document.getElementById("export-format").value = dataExtracted['Export Format'];
  if (typeof dataExtracted['Permission 1'] !== 'undefined') var permission1 = document.getElementById("permission-1").checked = checkReturn(dataExtracted['Permission 1']);
  if (typeof dataExtracted['Permission 2'] !== 'undefined') var permission2 = document.getElementById("permission-2").checked = checkReturn(dataExtracted['Permission 2']);
  if (typeof dataExtracted['Permission 3'] !== 'undefined') var permission3 = document.getElementById("permission-3").checked = checkReturn(dataExtracted['Permission 3']);
  if (typeof dataExtracted['Numeration Switch'] !== 'undefined') var numerationSwitch = document.getElementById("numeration-switch").checked = checkReturn(dataExtracted['Numeration Switch']);

  if (typeof dataExtracted['Email Field'] !== 'undefined') var emailField = document.getElementById("email-field").value = dataExtracted['Email Field'];
  if (typeof dataExtracted['Email Specific'] !== 'undefined') var emailSpecific = document.getElementById("email-specific").value = dataExtracted['Email Specific'];
  if (typeof dataExtracted['Email Sender'] !== 'undefined') var emailSender = document.getElementById("email-sender").value = dataExtracted['Email Sender'];
  if (typeof dataExtracted['Email Subject'] !== 'undefined') var emailSubject = document.getElementById("email-subject").value = dataExtracted['Email Subject'];
  if (typeof dataExtracted['Email More Fields'] !== 'undefined') var emailMoreFields = document.getElementById("email-more").checked = checkReturn(dataExtracted['Email More Fields']);
  if (typeof dataExtracted['Email BCC'] !== 'undefined') var emailBCC = document.getElementById("email-bcc").value = dataExtracted['Email BCC'];
  if (typeof dataExtracted['Email Reply To'] !== 'undefined') var emailReplyTo = document.getElementById("email-replyto").value = dataExtracted['Email Reply To'];
  if (typeof dataExtracted['Email Attach Switch'] !== 'undefined') var emailAttachSwitch = document.getElementById("email-addblob").checked = checkReturn(dataExtracted['Email Attach Switch']);
  if (typeof dataExtracted['Email Attach Field'] !== 'undefined') var emailAttachField = document.getElementById("email-blob-field").value = dataExtracted['Email Attach Field'];

  if (typeof dataExtracted['All Documents'] !== 'undefined') var allDocuments = document.getElementById("all-documents").checked = checkReturn(dataExtracted['All Documents']);
  if (typeof dataExtracted['All Emails'] !== 'undefined') var allEmails = document.getElementById("all-emails").checked = checkReturn(dataExtracted['All Emails']);

  

}

function checkReturn(arg) {
  if(arg === 'true') { return true; } else { return false; }
}

function afterButtonClickedSave() {

  var dsActivate = document.getElementById("ds-activate").checked;
  var emailActivate = document.getElementById("email-activate").checked;

  var templateID = document.getElementById("template-id").value;
  var greenCells = document.getElementById("green-cells").checked;

  var destinationFolder = document.getElementById("destination-folder").value;
  var fileName = document.getElementById("file-name").value;
  var exportFormat = document.getElementById("export-format").value;
  var permission1 = document.getElementById("permission-1").checked;
  var permission2 = document.getElementById("permission-2").checked;
  var permission3 = document.getElementById("permission-3").checked;
  var numerationSwitch = document.getElementById("numeration-switch").checked;

  var emailField = document.getElementById("email-field").value;
  var emailSpecific = document.getElementById("email-specific").value;
  var emailSender = document.getElementById("email-sender").value;
  var emailSubject = document.getElementById("email-subject").value;
  var emailMoreFields = document.getElementById("email-more").checked;
  var emailBCC = document.getElementById("email-bcc").value;
  var emailReplyTo = document.getElementById("email-replyto").value;
  var emailMessage = tinymce.activeEditor.getContent();
  var emailAttachSwitch = document.getElementById("email-addblob").checked;
  var emailAttachField = document.getElementById("email-blob-field").value;

  var allDocuments = document.getElementById("all-documents").checked;
  var allEmails = document.getElementById("all-emails").checked;

  var rowData = {
        dsActivate: dsActivate,
        emailActivate: emailActivate,

        templateID: templateID,
        greenCells: greenCells,

        destinationFolder: destinationFolder,
        fileName: fileName,
        exportFormat: exportFormat,
        permission1: permission1,
        permission2: permission2,
        permission3: permission3,
        numerationSwitch: numerationSwitch,

        emailField: emailField,
        emailSpecific: emailSpecific,
        emailSender: emailSender,
        emailSubject: emailSubject,
        emailMoreFields: emailMoreFields,
        emailBCC: emailBCC,
        emailReplyTo: emailReplyTo,
        emailMessage: emailMessage,
        emailAttachSwitch: emailAttachSwitch,
        emailAttachField: emailAttachField,

        allDocuments: allDocuments,
        allEmails: allEmails,
      };

  execFunction('saveDsConfiguration', 'Se ha guardado la configuración.', rowData);
}

</script>

<script>

function afterButtonClicked() {

  var dsActivate = document.getElementById("ds-activate").checked;
  var emailActivate = document.getElementById("email-activate").checked;
  var fieldsToValidate;

  if (dsActivate) {
    fieldsToValidate = document.querySelectorAll("#userform2 input, #userform select");
  };
  if (emailActivate) {
    fieldsToValidate = document.querySelectorAll("#userform3 input, #userform3 select");
  };

  if (dsActivate || emailActivate) {

    if(validate(fieldsToValidate)) {
      
      var templateID = document.getElementById("template-id").value;
      var greenCells = document.getElementById("green-cells").checked;

      var destinationFolder = document.getElementById("destination-folder").value;
      var fileName = document.getElementById("file-name").value;
      var exportFormat = document.getElementById("export-format").value;
      var permission1 = document.getElementById("permission-1").checked;
      var permission2 = document.getElementById("permission-2").checked;
      var permission3 = document.getElementById("permission-3").checked;
      var numerationSwitch = document.getElementById("numeration-switch").checked;

      var emailField = document.getElementById("email-field").value;
      var emailSpecific = document.getElementById("email-specific").value;
      var emailSender = document.getElementById("email-sender").value;
      var emailSubject = document.getElementById("email-subject").value;
      var emailBCC = document.getElementById("email-bcc").value;
      var emailReplyTo = document.getElementById("email-replyto").value;
      var emailMessage = tinymce.activeEditor.getContent();
      var emailAttachSwitch = document.getElementById("email-addblob").checked;
      var emailAttachField = document.getElementById("email-blob-field").value;

      var allDocuments = document.getElementById("all-documents").checked;
      var allEmails = document.getElementById("all-emails").checked;

      var rowData = {
            dsActivate: dsActivate,
            emailActivate: emailActivate,

            templateID: templateID,
            greenCells: greenCells,

            destinationFolder: destinationFolder,
            fileName: fileName,
            exportFormat: exportFormat,
            permission1: permission1,
            permission2: permission2,
            permission3: permission3,
            numerationSwitch: numerationSwitch,

            emailField: emailField,
            emailSpecific: emailSpecific,
            emailSender: emailSender,
            emailSubject: emailSubject,
            emailBCC: emailBCC,
            emailReplyTo: emailReplyTo,
            emailMessage: emailMessage,
            emailAttachSwitch: emailAttachSwitch,
            emailAttachField: emailAttachField,

            allDocuments: allDocuments,
            allEmails: allEmails,
          };

      swalConfirm('documentStudio', 'Morph Document Studio se ha ejecutado correctamente.', 'Una vez ejecutado no se puede detener. Confirma para continuar.', rowData);

    } else{ $('#errorNotFields').toast({delay: 4000}).toast("show");  }
  } else{ $('#errorNotFunctions').toast({delay: 4000}).toast("show"); }
}

function afterButtonClickedMarkers() {

  var fieldsToValidate = document.querySelectorAll("#userform2 input");

  if(validate(fieldsToValidate)) {

    var tplID = document.getElementById("template-id");
    var greenCells = document.getElementById("green-cells");
    var purgeMarkers = document.getElementById("purge-markers").checked;

    var rowData = {
      templateID: tplID.value,
      greenCells: greenCells.checked,
      purgeMarkers: purgeMarkers,
    };

    if (purgeMarkers) {
      swalConfirm('getMarkers', 'Los marcadores se han actualizado en la hoja.', 'Si seleccionas purgar, se eliminarán los datos de las columnas que no correspondan con algún marcador de la plantilla. Confirma para continuar.', rowData);
    } else{
      swaload();
      google.script.run.withSuccessHandler(e => {swalsuccess('Los marcadores se han actualizado en la hoja.'), afterSubmit(e)}).withFailureHandler(swalerror).getMarkers(rowData);
    }

  } else{ $("#errorNotFields").toast("show"); }
}

function afterSubmit(e) {
  clearFields(["template-id", "destination-folder", "file-name"]);
  var exportFormat = document.getElementById("export-format");
  exportFormat.value = "PDF";
  //$("#successNotification").toast("show");
}

function clearFields(feilds) {
  feilds.forEach(function(feild){
    var el = document.getElementById(feild);
    el.value = "";
  });
}

function validate(fieldsToValidate) {

  Array.prototype.forEach.call(fieldsToValidate, function(el){
    if (el.checkValidity()){
      el.classList.remove("is-invalid");
    } else{
      el.classList.add("is-invalid");
    }
  });

  return Array.prototype.every.call(fieldsToValidate,function(el){
    return el.checkValidity();
  });
}

</script>

<script>

  $(document).ready(function() {
    $('#btn-refresh-1, #btn-refresh-2').click(function() {
        $('#fa-sync-1, #fa-sync-2').addClass("fast-spin")
    });
  });
</script>

<script>

  document.getElementById("mainButton").addEventListener("click", afterButtonClicked);
  document.getElementById("markerButton").addEventListener("click", afterButtonClickedMarkers);
  document.getElementById("saveButton").addEventListener("click", afterButtonClickedSave);
  document.addEventListener('DOMContentLoaded', function() {
    afterSidebarLoads();
    getSavedProperties();
});

</script>

<?!= HtmlService.createHtmlOutputFromFile('public/helpers/swal').getContent(); ?>
<?!= HtmlService.createHtmlOutputFromFile('public/helpers/footer').getContent(); ?>

</body>
</html>
