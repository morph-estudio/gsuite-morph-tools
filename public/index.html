<html>
<head>
  <base target="_top">
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <?!= HtmlService.createHtmlOutputFromFile('public/helpers/header').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('public/stylesheet').getContent(); ?>

</head>

<body>

<?!= HtmlService.createHtmlOutputFromFile('public/helpers/navbar').getContent(); ?>

<!-- <?!= HtmlService.createHtmlOutputFromFile('public/helpers/csv').getContent(); ?> -->



<div class="accordion" id="accordionExample">
  <div class="accordion-item">
    <h2 class="accordion-header" id="headingOne">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
        Google Sheets
      </button>
    </h2>
    <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
      <div class="accordion-body pb-0 mt-2">

        <div class="mt-1 pb-0">
          <p>En esta app tienes las funciones implementadas por el equipo I+D para Google Suite.</p>
        </div>

        <button id="superFreezerButton" class="btn btn-primary gmt blue btn-lg-gmt w-100 mt-1 mb-3"  onclick="swalConfirm('morphFreezer', 'El archivo se ha congelado correctamente.', 'Una vez ejecutado no se puede detener. Confirma para continuar.', this.id)">Supercongelador</button>

        <!-- <button class="btn btn-primary btn-lg-gmt mt-1 mb-3"  onclick="swalConfirm('exportXML', 'El archivo se ha convertido correctamente.', 'Congelar', 'Una vez ejecutado no se puede detener. Confirma para continuar.')">EXPORTAR XML</button> -->
      
      </div>
      <div id="button-container" class="accordion-body px-0 pb-0">
        <button class="btn btn-primary index w-100 shadow-none" title="Crea una lista de usuarios del Google Workspace de Morph" onclick="swalConfirm('getDomainUsersList', 'Se ha creado una lista de usuarios.', 'Asegúrate de estar en una hoja en blanco antes de continuar.')"><i class="fa-solid fa-margin fa-users fa-fw"></i>Lista de miembros Morph</button>
        <div class="btn-group d-flex" role="group">
          <button class="btn btn-primary index shadow-none half w-50" onclick="execNoSuccess('drawPalette')"><i class="fa-solid fa-margin fa-palette fa-fw"></i>Paleta Morph</button>
          <button class="btn btn-primary index shadow-none w-50" onclick="execDirect('colorMe')"><i class="fa-solid fa-margin fa-fill-drip fa-fw"></i>Color Morph</button>
        </div>
        <button class="btn btn-primary index shadow-none w-100" onclick="execNoSuccess('deleteEmptyRows')"><i class="fa-solid fa-margin fa-table-list fa-fw"></i>Eliminar filas vacías</button>
        <button class="btn btn-primary index shadow-none w-100" onclick="execNoSuccess('removeEmptyColumns')"><i class="fa-solid fa-margin fa-table-columns fa-fw"></i>Eliminar columnas vacías</button>
        <button class="btn btn-primary index shadow-none w-100" onclick="execNoSuccess('mergeColumns')"><i class="fa-solid fa-margin fa-circle-h fa-fw"></i>Unificar columnas con el mismo encabezado</button>
        <button class="btn btn-primary index shadow-none w-100" title="Genera un identificador por cada celda seleccionada" onclick="execNoSuccess('uniqueIdentifier')"><i class="fa-solid fa-barcode fa-margin fa-fw"></i>Identificadores automáticos</button>
        <button class="btn btn-primary index shadow-none w-100" onclick="execNoSuccess('exportSheet')"><i class="fa-solid fa-database fa-margin fa-fw"></i>Exportar hoja a formato JSON</button>

        <div class="btn-group d-flex" role="group">
          <button class="btn btn-primary index shadow-none half w-50" title="Aumenta proporcionalmente el tamaño de letra en la hoja" onclick="execNoSuccess('increaseFontSize')"><i class="fa-solid fa-margin fa-fw fa-arrows-up-to-line"></i>Font Size +</button>
          <button class="btn btn-primary index shadow-none w-50" title="Disminuye proporcionalmente el tamaño de letra en la hoja" onclick="execNoSuccess('decreaseFontSize')"><i class="fa-solid fa-margin fa-fw fa-arrows-down-to-line"></i>Font Size -</button>
        </div>

        <!--<div class="btn-group d-flex" role="group">
          <button class="btn btn-primary index shadow-none half w-50" title="Ajusta las filas al texto existente" onclick="execNoSuccess('autoResizeAllRows')"><i class="fa-solid fa-margin fa-fw fa-sliders"></i>Fit Filas</button>
          <button class="btn btn-primary index shadow-none w-50" title="Ajusta las columnas al texto existente" onclick="execNoSuccess('autoResizeAllCols')"><i class="fa-solid fa-margin fa-fw fa-sliders"></i>Fit Colms</button>
          <button class="btn btn-primary index shadow-none w-100" onclick="execNoSuccess('postLessons')"><i class="fa-solid fa-comments fa-margin fa-fw"></i>Enviar mensajes de Chat</button>
        </div>-->

      </div>
    </div>
  </div>

  <div class="accordion-item">
    <h2 class="accordion-header" id="headingTwo">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
        Superficies
      </button>
    </h2>
    <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionExample">
      <div class="accordion-body mt-2">

        <div class="">
          <p>Diseñado para funcionar en las copias de la <b>NAVE NODRIZA</b> del cuadro de superficies.</p>

          <div class="input-group flex-nowrap update rounded-pill mb-3">
            <span class="input-group-text">Prefijo</span>
            <input type="text" class="form-control shadow-none" id="updatePrefixID" placeholder="Por defecto: TXT">
          </div>

          <div class="form-check form-switch mb-3 mt-0">
            <input class="form-check-input" type="checkbox" role="switch" id="prefix-all-switch" onclick="document.getElementById('updatePrefixID').disabled = this.checked">
            <label class="form-check-label" style="position:relative;top:2px" for="prefix-all-switch">Añadir todos los archivos</label>
          </div>       

          <button id="csUpdater" class="btn btn-primary gmt sup yellow w-100 shadow-none mb-1">Actualizar cuadro de superficies</button>
          <button id="csFreezer" class="btn btn-primary gmt inf blue w-100 shadow-none" onclick="swalConfirm('morphFreezer', 'El archivo se ha congelado correctamente.', 'Una vez ejecutado no se puede detener. Confirma para continuar.', this.id)">Congelar cuadro de superficies</button>
        </div>

        <div class="mt-4">
          <h3><i class="fa-solid fa-margin fa-fw fa-triangle-exclamation"></i>Transición de cuadros</h3>
          <p>Si es un cuadro anterior a <u>Octubre 2022</u> debes adaptarlo antes de actualizar.</p>
          <button class="btn btn-success mainbtn btn-xl w-100" id="adaptButton" onclick="execFunction('adaptarCuadroAntiguo', 'El cuadro se ha adaptado correctamente.')">Adaptar cuadro antiguo</button>
          <!--<button class="btn btn-primary mainbtn btn-lg-gmt w-100 mt-4" id="adaptDeleteButton" onclick="execNoSuccess('deleteProperty', 'adaptedSpreadsheet')">Adaptar cuadro antiguo</button>-->
        </div>

      </div>
    </div>
  </div>

  <div class="accordion-item">
    <h2 class="accordion-header" id="headingThree">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
        Archivos y carpetas
      </button>
    </h2>
    <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#accordionExample">
      <div class="accordion-body mt-2 pb-2">

        <div class="mb-4">
          <h3>Estructura de carpetas</h3>
          <p>Hay que seguir la estructura de niveles de la <b>plantilla</b>.</p>
        
          <button class="btn btn-primary gmt sup grey w-100 shadow-none mb-1" onclick="execFunction('autoFolderTreeTpl', 'Se ha generado una plantilla para la estructura de carpetas.')">Crear plantilla</button>
          <button class="btn btn-primary gmt inf pink w-100 shadow-none" onclick="swalConfirm('autoFolderTree', 'Se ha generado la estructura de carpetas.', 'Una vez ejecutado no se puede detener. Confirma para continuar.')">Generar estructura de carpetas</button>
        </div>

        <div class="">
          <h3>Listado de archivos</h3>
          <p>Genera una lista con nombres y links de archivos en una carpeta.</p>
          <?!= HtmlService.createHtmlOutputFromFile('public/helpers/form-folderlist').getContent(); ?>
        </div>

      </div>
    </div>
  </div>

  <div class="accordion-item">
    <h2 class="accordion-header" id="headingFour">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
        Desarrollo
      </button>
    </h2>
    <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#accordionExample">

      <div id="password_div">
        <div class="accordion-body mt-2 pb-0 mb-4">
          <div class="card bg-light" >
            <div class="card-body">
      
              <label for="hidden_password" class="form-label"><i class="fa-solid fa-key fa-margin fa-fw"></i>Introduce una clave:</label>
              <div class="input-group flex-nowrap update rounded-pill">
                <!--<span class="input-group-text"><i class="fas fa-lock"></i></span>-->
                <input name="password" type="password" value="" class="input form-control shadow-none" id="hidden_password" required="true" onkeydown = "if (event.keyCode == 13) document.getElementById('hideSectionButton').click()"/>
                <span class="input-group-text" onclick="password_show_hide();">
                  <i class="fas fa-eye fa-fw" id="show_eye"></i>
                  <i class="fas fa-eye-slash d-none fa-fw" id="hide_eye"></i>
                </span>
              </div>
              <div id="invalid-developer" class="text-danger mt-2 collapse">asdf</div>
              <button class="btn btn-secondary btn-lg-gmt w-100 mt-2" id="hideSectionButton">Desbloquear</button>

            </div>
          </div>
        </div>
      </div>

      <div id="hidden_div" style="display: none;" class="mt-4">
        <div class="accordion-body pb-0">
          <h3 class="menu-h3 mb-3"><i class="fa-solid fa-margin fa-fw fa-laptop-code"></i>Funciones en desarrollo</h3>
        </div>

        <button class="btn btn-primary index shadow-none w-100" onclick="swalConfirm('botBrainSave', 'Se ha acualizado la IA de Morph Robot', 'Por favor, no utilices esta función avanzada si no sabes lo que estás haciendo. Confirma para continuar.')"><i class="fa-solid fa-brain fa-margin fa-fw"></i>Actualizar cerebro de robot</button>
        <button class="btn btn-primary index shadow-none w-100" onclick="swalConfirm('morphFastFreezer', 'El archivo se ha congelado correctamente.', 'Una vez ejecutado no se puede detener. Confirma para continuar.')"><i class="fa-solid fa-margin fa-snowflake fa-fw"></i>Congelador rápido</button>
        <button class="btn btn-primary index shadow-none w-100" onclick="execFunction('saveSheetAsTSV')"><i class="fa-solid fa-margin fa-file-excel fa-fw"></i>Exportar TSV con fórmulas</button>
        <button class="btn btn-primary index shadow-none w-100" onclick="execNoSuccess('postLessons')"><i class="fa-solid fa-comments fa-margin fa-fw"></i>Enviar mensajes de Chat</button>
        <button class="btn btn-primary index shadow-none w-100" onclick="execNoSuccess('createTimeTriggerSpecifcDate')"><i class="fa-solid fa-comments fa-margin fa-fw"></i>Programar base de mensajes</button>

        <button class="btn btn-primary index shadow-none w-100" id="adaptDeleteButton" onclick="execNoSuccess('deleteProperty', 'adaptedSpreadsheet')"><i class="fa-solid fa-unlock fa-margin fa-fw"></i>Desbloquear botón adaptar</button>
        <button class="btn btn-primary index shadow-none w-100 ult" onclick="swalinfo()"><i class="fa-solid fa-gear fa-margin fa-fw fa-spin" style="--fa-animation-duration: 6s;"></i>Destructor de mundos</button>

        <div class="accordion-body pb-0 mt-4">
          <h3 class="menu-h3 mb-3"><i class="fa-solid fa-margin fa-fw fa-square-caret-down"></i>Menú para developers</h3>
        </div>
        <button class="btn btn-primary index shadow-none w-100" onclick="execDirect('sidebarSMDevs')"><i class="fa-solid fa-margin fa-fw fa-file-circle-check"></i>Gestor de hojas</button>
        <button class="btn btn-primary index shadow-none w-100" onclick="execDirect('sidebarDSDevs')"><i class="fa-solid fa-margin fa-fw fa-wand-magic-sparkles"></i>Morph Document Studio</button>
        <button class="btn btn-primary index shadow-none w-100 ult" onclick="execDirect('sidebarCLDevs')"><i class="fa-solid fa-margin fa-fw fa-swatchbook"></i>Guía de estilos</button>
      </div>

      <?!= HtmlService.createHtmlOutputFromFile('public/helpers/mupdate').getContent(); ?>
      <?!= HtmlService.createHtmlOutputFromFile('public/helpers/csv').getContent(); ?>

      
      </div>

    </div>


  <div class="accordion-item last">
    <h2 class="accordion-header" id="headingFive">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFive" aria-expanded="false" aria-controls="collapseFive">
        Ayuda
      </button>
    </h2>
    <div id="collapseFive" class="accordion-collapse collapse" aria-labelledby="headingFive" data-bs-parent="#accordionExample">
      <div class="accordion-body mt-2">

        <div class="progress">
          <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width:<?= cellCounter() ?>%"><span class="justify-content-center d-flex position-absolute w-100"><?= cellCounter() ?>%</span></div>
          </div>

        <?!= HtmlService.createHtmlOutputFromFile('public/helpers/counter').getContent(); ?>
        <?!= HtmlService.createHtmlOutputFromFile('public/helpers/help').getContent(); ?>

      </div>
    </div>
  </div>

</div>

<script>

  function afterSidebarLoads(){
    setTimeout(function(){removeFadeOut(document.getElementById('loading-spin'), 300)}, 300);
  }

</script>

<script>

  function check_password () {
    btnLoading('#hideSectionButton', 'Validando...');
    var field = document.getElementById('hidden_password');
    var password = field.value;

    if (password == '') {
      $('#invalid-developer').html('<small>El campo no puede estar vacío.</small>').addClass("show");
      field.classList.add("is-invalid"); setTimeout(function(){validatePassword(field); $('#invalid-developer').removeClass("show").addClass("collapse") }, 3500);
      btnReset("#hideSectionButton");
    } else {
      google.script.run.withSuccessHandler(function(data){
      if (data.includes(password)) {
          // $('#password_div').hide();
          document.getElementById('hidden_div').style.display = 'block';
      } else if (password == 'mupdate') {
        document.getElementById('manualUpdateDiv').style.display = 'block';
      } else if (password == 'icsv') {
        document.getElementById('icsv').style.display = 'block';
        /*async function secondFunction(){
          await getSavedCSVImport();
          // now wait for firstFunction to finish...
          document.getElementById('icsv').style.display = 'block';
        } */
      } else if (password == 'desbutadaptar') {
        execNoSuccess('deleteProperty', 'adaptedSpreadsheet');
        execDirect('sidebarIndex');
      } else {
        $('#invalid-developer').html('<small>La clave es incorrecta.</small>').addClass("show");
        field.classList.add("is-invalid"); setTimeout(function(){validatePassword(field);  $('#invalid-developer').removeClass("show").addClass("collapse") }, 3500);
      }
      btnReset("#hideSectionButton");
      $('#hidden_password').val('');  
      }).getDevPassword('DevAreaKeys');
    }
  }

  function validatePassword(field) {
    field.classList.remove("is-invalid");
  }

  function check_userRole(field) {
    let protection = JSON.parse("<?=JSON.stringify(protection)?>");
    if (protection === true) {
        document.getElementById('hidden_div').style.display = 'block';
    } else {
      document.getElementById('hidden_div').style.display = 'none';
    }
  }

  function validatePassword(field) {
    field.classList.remove("is-invalid");
  }

  function updateButtonClicked() {
    let updatePrefix = document.getElementById('updatePrefixID').value;
    let prefixAll = document.getElementById("prefix-all-switch").checked;
    let btnID = 'csUpdater';

    var rowData = {
          updatePrefix: updatePrefix,
          prefixAll: prefixAll,
        };

    swalConfirm('morphCSUpdater', 'El cuadro se ha actualizado correctamente.', 'Una vez ejecutado no se puede detener. Confirma para continuar.', btnID, rowData);
  }

</script>

<script>

  function password_show_hide() {
    var x = document.getElementById("hidden_password");
    var show_eye = document.getElementById("show_eye");
    var hide_eye = document.getElementById("hide_eye");
    hide_eye.classList.remove("d-none");
    if (x.type === "password") {
      x.type = "text";
      show_eye.style.display = "none";
      hide_eye.style.display = "block";
    } else {
      x.type = "password";
      show_eye.style.display = "block";
      hide_eye.style.display = "none";
    }
  }

</script>

<script>

  function adaptButtonDisable() {
    $('#adaptButton').prop('disabled', true);
    $('#adaptButton').html('Ya se ha adaptado');
  }

  function getSavedProperties() {
    let data = JSON.parse("<?=JSON.stringify(isAdapted)?>");
    let dataExtracted = data;
    if (data == 'true') {
      adaptButtonDisable()
    }
  }
  function checkReturn(arg) {
    if(arg === 'true') { return true; } else { return false; }
  }

</script>

<script> // Script to order buttons alphabetically (and add ult_class to last child)

  'use strict';
  const buttonContainer = document.getElementById('button-container');
  const sortedButtons = [... buttonContainer.children].sort((buttonA, buttonB) => {
    const name1 = buttonA.innerText.toLowerCase();
    const name2 = buttonB.innerText.toLowerCase();
    if(name1 === name2){
      return 0;
    } else if(name1 < name2){
      return -1;
    } else {
      return 0;
    }
  });
  sortedButtons.forEach(button => buttonContainer.append(button));

  $("#button-container").children().last().addClass("ult");

</script>

<script>

  document.getElementById('hideSectionButton').addEventListener("click", check_password);
  document.getElementById('csUpdater').addEventListener("click", updateButtonClicked);
  document.addEventListener('DOMContentLoaded', () => {
    check_userRole();
    afterSidebarLoads();
    getSavedProperties();
    getSavedCSVImport();
  });

</script>

<?!= HtmlService.createHtmlOutputFromFile('public/helpers/swal').getContent(); ?>
<?!= HtmlService.createHtmlOutputFromFile('public/helpers/footer').getContent(); ?>

</body>
</html>
