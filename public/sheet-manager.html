<html>
<head>
  <base target="_top">
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.0/dist/bootstrap-table.min.css">
  <link href="https://unpkg.com/bootstrap-table@1.21.0/dist/extensions/reorder-rows/bootstrap-table-reorder-rows.css" rel="stylesheet">

  <link href="https://unpkg.com/bootstrap-table@1.21.2/dist/bootstrap-table.min.css" rel="stylesheet">
  <link href="https://unpkg.com/bootstrap-table@1.21.2/dist/extensions/reorder-rows/bootstrap-table-reorder-rows.css" rel="stylesheet">

  <?!= HtmlService.createHtmlOutputFromFile('public/helpers/header').getContent(); ?>
  <?!= HtmlService.createHtmlOutputFromFile('public/stylesheet').getContent(); ?>

  <script src="https://cdn.jsdelivr.net/npm/tablednd@1.0.5/dist/jquery.tablednd.min.js"></script>
  <script src="https://unpkg.com/bootstrap-table@1.21.2/dist/bootstrap-table.min.js"></script>
  <script src="https://unpkg.com/bootstrap-table@1.21.2/dist/extensions/reorder-rows/bootstrap-table-reorder-rows.min.js"></script>
  
  
</head>

<body>

<?!= HtmlService.createHtmlOutputFromFile('public/helpers/navbar').getContent(); ?>

<div class="btn-group d-flex" role="group">
  <button id="refresh-button" class="btn btn-secondary rounded-0 shadow-none ps-3 border-0 greybutton1" style="">Actualizar hojas</button>
  <button id="reorderButton" class="btn btn-secondary rounded-0 shadow-none ps-3 border-0 greybutton2" style="">Reordenar</button>
</div>

<button id="delete-button" class="btn btn-primary btn-xl w-100 rounded-0 shadow-none pt-2 pb-2 ps-3" style="font-size: 26px;">Ejecutar</button>

<select id="select-action" class="form-select form-select-lg border-0 border-bottom rounded-0 mt-0 shadow-none" data-role="select" data-filter="false">
  <option value="actDelete" selected="selected">Eliminar</option>
  <option value="actClear">Limpiar</option>
  <option value="actDuplicate">Duplicar</option>
  <option value="actHide">Ocultar</option>
  <option value="actShow">Mostrar</option>
  <option value="actPartialFreezer">Congelador parcial</option>
</select>

<input type="text" class="form-control form-control-lg border-0 border-bottom rounded-0 mt-0 shadow-none" id="sheet-deleter-search" placeholder="Buscar hojas..." aria-describedby="destination-folder-help">

<div class="body-padding pb-3">

  

  <div id="errorNotSheets" class="toast fade hide shadow-sm w-100 mt-2" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Warning:"><use xlink:href="#exclamation-triangle-fill"/></svg>
      <strong class="me-auto">Advertencia</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body">
      No has seleccionado ninguna hoja.
    </div>
  </div>

  <table class="table table-striped borderless"
    id="table"
    data-toolbar=".toolbar"
    data-pagination="false"
    data-pagination-h-align="left"
    data-search="true"
    data-search-selector="#sheet-deleter-search"
    data-click-to-select="false"
    data-page-list="[7, 15, 20, all]"
    data-page-size="7"
    data-pagination-pages-by-side="1"
    data-pagination-successively-size="1"
    data-maintain-meta-data="true"
    data-use-row-attr-func="true"
    data-reorderable-rows="true"
    >
    <thead>
      <tr>
        <th data-field="state" data-checkbox="true"></th>
        <!-- <th data-field="id">ID</th> -->
        <th data-field="name" class="listOfSheets">Hojas</th>
        <th data-field="button"></th>
      </tr>
    </thead>

  </table>
</div>

<!-- *****Javascript***** -->

<script>
  const WorksheetDeleteApp = {};
  var $table = $('#table')
  var wsNames = JSON.parse("<?=JSON.stringify(wsNames)?>");
  var dataids = [];

  WorksheetDeleteApp.loadWorksheetNames = function() {
    var data = [];

    Object.keys(wsNames).forEach(function(key){ 
      var value = wsNames[key]; 
      data.push(value);
      dataids.push(JSON.parse(key));
    });
    $table.bootstrapTable({data: wsNames});
    
    //alert(JSON.stringify(wsNames))
    WorksheetDeleteApp.updateHiddenSheets(wsNames);

    setTimeout(function(){removeFadeOut(document.getElementById('loading-spin'), 300)}, 250);
    //alert(JSON.stringify($table.bootstrapTable('getData', false)))
  }

  WorksheetDeleteApp.updateHiddenSheets = function(sheetData) {
    $("#table tr:not(:has(th))").each(function(i) {
      let isHidden = JSON.stringify(sheetData[i].ishidden);
      //alert(`${JSON.stringify(wsNames[i])} es ${isHidden}`);
      if (isHidden == "true") {
        let self = $(this);
        self.find("td:eq(1)").css('color', '#9E9E9E');
      }
    });
  }

</script>

<script>
  WorksheetDeleteApp.refreshWorksheets = function(){
    google.script.run.withSuccessHandler(sheetNames => {
        $table.bootstrapTable('removeAll');
        $table.bootstrapTable('append', sheetNames);
        btnReset('#refresh-button');
        WorksheetDeleteApp.updateHiddenSheets(sheetNames);
    }).getWorksheetNames()
  }

  WorksheetDeleteApp.deleteSheets = function(){
    var sheetNamesToDeleteAsString = JSON.stringify($table.bootstrapTable('getSelections'));
    var sdAction = document.getElementById('select-action').value;
    var rowData = {
    sdAction: sdAction,
    };

    swaload()
    google.script.run.withSuccessHandler(e => {WorksheetDeleteApp.refreshWorksheets(), WorksheetDeleteApp.successValues(sdAction)})
    .withFailureHandler(swalerror).worksheetManagement(sheetNamesToDeleteAsString, rowData)
  }
</script>


<script>
  WorksheetDeleteApp.openDialogActions = function(){
    let numberOfSheets = $table.bootstrapTable('getSelections').length;
    let optionSelected = $('#select-action option:selected').text().toLowerCase();
    let hojaplurales; if (numberOfSheets > 1) { hojaplurales = `hojas` } else { hojaplurales = `hoja` }

    if (numberOfSheets === 0) { 
      $('#errorNotSheets').toast({delay: 4000}).toast("show");
    } else {
      let swalFireText;
      if (optionSelected == 'congelador parcial') {
        swalFireText = `Se crearÃ¡ un archivo congelado con ${numberOfSheets} ${hojaplurales}.`
      } else {
        swalFireText = `Vas a ${optionSelected} ${numberOfSheets} ${hojaplurales}.`
      }

      Swal.fire({
        text: swalFireText,
        icon: 'info',
        allowOutsideClick: false,
        showLoaderOnConfirm: true,
        showDenyButton: false,
        showCancelButton: true,
        cancelButtonText: `Cancelar`,
        confirmButtonText: `Continuar`,
        confirmButtonColor: '#0D6EFD',
        customClass: {
          popup: 'swal-container',
        }
      }).then((result) => {
        if (result.isConfirmed) {
          WorksheetDeleteApp.deleteSheets();
        } else if (result.isDenied) {
          return;
        }
      })
    }
  }

  WorksheetDeleteApp.successValues = function(sdAction){
    if (sdAction == "actPartialFreezer") { swalsuccess("El archivo se ha congelado correctamente.") } else { success() }
  }
</script>

<!-- Reorder sheets -->
<script>
  $('#reorderButton').click(function () {
    let rowReorderedsend = $table.bootstrapTable('getData', false);
    swaload()
    google.script.run.withSuccessHandler(e => {WorksheetDeleteApp.refreshWorksheets(), success()}).withFailureHandler(swalerror).rearrangeSheets(rowReorderedsend)
  })


	$(document).on("click", ".viewSheetButton", function(){
    
    let sheetName = $(this).closest('tr').find("td:eq(1)").html();
    google.script.run.withSuccessHandler(e => {WorksheetDeleteApp.refreshWorksheets()}).goToSheet(sheetName)
/*
    let sheetName = $(this).closest('tr').find("td:eq(1)").html();
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = spreadsheet.getSheetByName(sheetName);
    spreadsheet.setActiveSheet(sheet);
*/
  });

  $("#table").on('search.bs.table', function (t){
    WorksheetDeleteApp.updateHiddenSheets(wsNames);
  });
</script>


<script>
  $(document).ready(function() {
    headerLight();
    google.script.run.fastInit();
    WorksheetDeleteApp.loadWorksheetNames();
    // Initialise the table reorder
    $('#table').tableDnD();
  });

  $(document).change(function() {
    $("#table").tableDnD();
  });

  document.getElementById("delete-button").addEventListener("click", WorksheetDeleteApp.openDialogActions)
  document.getElementById("refresh-button").addEventListener("click", WorksheetDeleteApp.refreshWorksheets)
  $("#refresh-button").click(function() {
      btnLoading('#refresh-button', 'Actualizando...');
  });
</script>




<script>

/*
$("#table").on('onDrop', function (e, data){
    alert('felguera')
});

var $button = $('#reorderButton');
$(function() {
  $button.click(function () {
    $table.bootstrapTable('data-on-reorder-rows-drop', WorksheetDeleteApp.refreshWorksheets(parameter))
    $table.bootstrapTable('scrollTo', 'bottom')
  })
})

WorksheetDeleteApp.onReorderFunction = function(){
  alert('felguera')
}

$.extend($.fn.bootstrapTable.defaults, {classes:'table'});
*/
</script>



<?!= HtmlService.createHtmlOutputFromFile('public/helpers/swal').getContent(); ?>
<?!= HtmlService.createHtmlOutputFromFile('public/helpers/footer').getContent(); ?>


</body>
</html>
